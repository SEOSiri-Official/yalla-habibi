{% extends "base.html" %}

{% block title %}Yalla Habibi{% endblock %}

{% block content %}

    

    <div class="glass-card">
        <header>
            <h1>Yalla <span>Habibi</span></h1>
            <p id="hook">"I am your Native Arabic host. How can I bridge your world today?"</p>
            
            <div class="pref-container">
                <label>Select Your Tongue:</label>
                <select id="pref-lang">
            <option value="bn-BD">ğŸ‡§ğŸ‡© Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
            <option value="hi-IN">ğŸ‡®ğŸ‡³ Hindi</option>
            <option value="es-ES">ğŸ‡ªğŸ‡¸ Spanish</option>
            <option value="pt-BR">ğŸ‡§ğŸ‡· Portuguese</option>
            <option value="fr-FR">ğŸ‡«ğŸ‡· French</option>
            <option value="de-DE">ğŸ‡©ğŸ‡ª German</option>
            <option value="it-IT">ğŸ‡®ğŸ‡¹ Italian</option>
            <option value="ru-RU">ğŸ‡·ğŸ‡º Russian</option>
            <option value="ja-JP">ğŸ‡¯ğŸ‡µ Japanese</option>
            <option value="ko-KR">ğŸ‡°ğŸ‡· Korean</option>
            <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese</option>
            <option value="tr-TR">ğŸ‡¹ğŸ‡· Turkish</option>
            <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Arabic</option>
            <option value="en-US" selected>ğŸŒ English</option>
        </select>
            </div>
            <div class="secondary-links">
    <a href="/manual">ğŸ“˜ User Manual</a>
</div>

        </header>

        <!-- DEMOGRAPHIC HINT SYMBOLS -->
        <div class="benefit-hints">
            <span>ğŸ‘·â€â™‚ï¸ Translation for Work</span> â€¢ <span>ğŸ“ Moral Lessons</span> â€¢ <span>ğŸŒ Eco Tips</span>
        </div>

        <!-- ===== VOICE CONTROLS SECTION ===== -->
        <div class="voice-controls">
            <h3>ğŸšï¸ Voice Controls</h3>
            
            <div class="control-group">
                <label>
                    ğŸ”Š Volume
                    <span id="volume-value">100%</span>
                </label>
                <input type="range" min="0" max="100" value="100" class="slider" id="volume-slider">
            </div>

            <div class="control-group">
                <label>
                    âš¡ Speed
                    <span id="speed-value">Normal</span>
                </label>
                <input type="range" min="50" max="200" value="95" class="slider" id="speed-slider">
            </div>

            <div class="voice-action-buttons">
                <button class="voice-btn stop" id="stop-btn" onclick="stopSpeaking()" disabled>
                    â¹ï¸ Stop Speaking
                </button>
                <button class="voice-btn replay" id="replay-btn" onclick="replaySpeech()" disabled>
                    ğŸ” Replay Last
                </button>
            </div>

            <div class="speaking-indicator" id="speaking-indicator">
                <span>Speaking:</span>
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="wave"></div>
            </div>
        </div>

        <div class="main-body">
            <div id="status">Speak to Habibi...</div>
            <button id="mic-btn" onclick="startSpeech()">
                <div class="pulse" id="pulse"></div>
                <span>ğŸ™ï¸</span>
            </button>
            <div id="user-transcript">...</div>

            <div class="ai-box">
                <div id="response-text">Marhaba! I assist foreigners across the Peninsula.</div>
                <div id="map-wrap" class="hidden">
                    <iframe id="google-map" width="100%" height="200" src=""></iframe>
                </div>
                <div id="wisdom-box" class="hidden"><p id="wisdom-text"></p></div>
            </div>
        </div>

        <!-- ===== NEW: SOCIAL SHARE SECTION ===== -->
        <div class="social-share-section">
            <div class="share-gpt">
    âœ¨ Explore Habibi on GPT:
    <a href="https://chatgpt.com/g/g-698b641c04208191bb1c0f8861bac508-yalla-habibi-multilingual-voice-translation"
       target="_blank">
       Yalla Habibi GPT Experience
    </a>
</div>



            <h3>ğŸš€ Share Yalla Habibi</h3>
            <p class="share-subtitle">Help others discover this multilingual AI assistant!</p>
            
            <div class="share-buttons">
                <a href="#" class="share-btn facebook" onclick="shareOnFacebook(); return false;">
                    <span>ğŸ“˜ Facebook</span>
                </a>
                <a href="#" class="share-btn twitter" onclick="shareOnTwitter(); return false;">
                    <span>ğ• Twitter</span>
                </a>
                <a href="#" class="share-btn linkedin" onclick="shareOnLinkedIn(); return false;">
                    <span>ğŸ’¼ LinkedIn</span>
                </a>
                <a href="#" class="share-btn whatsapp" onclick="shareOnWhatsApp(); return false;">
                    <span>ğŸ’¬ WhatsApp</span>
                </a>
                <a href="#" class="share-btn telegram" onclick="shareOnTelegram(); return false;">
                    <span>âœˆï¸ Telegram</span>
                </a>
                <a href="#" class="share-btn reddit" onclick="shareOnReddit(); return false;">
                    <span>ğŸ¤– Reddit</span>
                </a>
            </div>

            <div class="copy-link-section">
                <input type="text" class="copy-link-input" id="share-url" readonly value="https://www.seosiri.com">
                <button class="copy-link-btn" id="copy-btn" onclick="copyShareLink()">
                    ğŸ“‹ Copy Link
                </button>
            </div>

            <div class="share-stats">
                Thank you for sharing! Every share helps grow our community ğŸ’š
            </div>
        </div>

        <div class="community-ticker">
            <div class="ticker-content" id="ticker">"Worlds are waiting to listen to you..." - Share your feedback!</div>
        </div>

        <div class="feedback-box">
            <input type="text" id="feedback-in" placeholder="Loved Yalla Habibi? Share...">
            <button onclick="postFeedback()">Post</button>
        </div>

        <footer>
            Created by <a href="https://www.seosiri.com/p/about.html" target="_blank">Momenul Ahmad</a> | SEOSiri
        </footer>
    </div>

    <script>
        // =====================================================================
        // VOICE CONTROL VARIABLES
        // =====================================================================
        let currentUtterance = null;
        let lastResponseText = "";
        let lastResponseLang = "en-US";
        let isSpeaking = false;
        let speechVolume = 1.0;
        let speechRate = 0.95;



        /* ============================================================
   DOMAIN-SAFE SHARE CONFIG
============================================================ */
const SHARE_CONFIG = {
    url: window.location.origin,
    title: "Yalla Habibi â€“ Multilingual Voice Assistant"
};



/* ============================================================
   SHARE FUNCTIONS (FIXED)
============================================================ */
function shareOnFacebook() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_CONFIG.url)}`;
    window.open(url, 'fb', 'width=600,height=400');
}

function shareOnTwitter() {
    const text = encodeURIComponent(`ğŸ™ï¸ Yalla Habibi\n${SHARE_CONFIG.url}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`);
}

function shareOnLinkedIn() {
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_CONFIG.url)}`);
}

function shareOnWhatsApp() {
    const text = encodeURIComponent(`Yalla Habibi\n${SHARE_CONFIG.url}`);
    window.open(`https://wa.me/?text=${text}`);
}

function shareOnTelegram() {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_CONFIG.url)}`);
}

function shareOnReddit() {
    window.open(`https://reddit.com/submit?url=${encodeURIComponent(SHARE_CONFIG.url)}`);
}

function copyShareLink() {
    navigator.clipboard.writeText(SHARE_CONFIG.url);
    const btn = document.getElementById("copy-btn");
    btn.innerText = "âœ… Copied!";
    setTimeout(() => btn.innerText = "ğŸ“‹ Copy Link", 1500);
}

console.log("âœ… Share system locked to:", SHARE_CONFIG.url);

        // =====================================================================
        // SPEECH RECOGNITION SETUP
        // =====================================================================
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        // =====================================================================
        // VOICE CONTROL SLIDERS
        // =====================================================================
        const volumeSlider = document.getElementById('volume-slider');
        const speedSlider = document.getElementById('speed-slider');
        const volumeValue = document.getElementById('volume-value');
        const speedValue = document.getElementById('speed-value');

        volumeSlider.addEventListener('input', function() {
            speechVolume = this.value / 100;
            volumeValue.textContent = this.value + '%';
            
            if (currentUtterance && isSpeaking) {
                currentUtterance.volume = speechVolume;
            }
        });

        speedSlider.addEventListener('input', function() {
            speechRate = this.value / 100;
            const speedText = this.value < 80 ? 'Slow' : 
                            this.value < 110 ? 'Normal' : 'Fast';
            speedValue.textContent = speedText + ' (' + this.value + '%)';
            
            if (currentUtterance && isSpeaking) {
                currentUtterance.rate = speechRate;
            }
        });

        // =====================================================================
        // UI RESET HELPER
        // =====================================================================
        function resetUI(message = "Speak to Habibi...") {
            document.getElementById('pulse').style.display = 'none';
            document.getElementById('status').innerText = message;
            document.getElementById('mic-btn').classList.remove('recording');
        }

        // =====================================================================
        // SPEECH RECOGNITION HANDLERS
        // =====================================================================
        recognition.onstart = () => {
            document.getElementById('pulse').style.display = 'block';
            document.getElementById('status').innerText = "Habibi is listening...";
            document.getElementById('mic-btn').classList.add('recording');
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            resetUI("Error: " + event.error + ". Try again!");
        };

        recognition.onend = () => {
            if (document.getElementById('status').innerText === "Habibi is listening...") {
                resetUI("No speech detected. Try again!");
            }
        };

        function startSpeech() { 
            try { 
                recognition.start(); 
            } catch(e) {
                console.log('Recognition already started or error:', e);
            } 
        }

        // =====================================================================
        // SPEECH RECOGNITION RESULT HANDLER
        // =====================================================================
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            const pref = document.getElementById('pref-lang').value;
            
            document.getElementById('user-transcript').innerText = `"${text}"`;
            document.getElementById('status').innerText = "Processing...";
            document.getElementById('pulse').style.display = 'none';

            fetch(`/api/chat?user_input=${encodeURIComponent(text)}&pref=${pref}`)
                .then(r => {
                    if (!r.ok) throw new Error('Network response was not ok');
                    return r.json();
                })
                .then(data => {
                    resetUI("Response received! Speak again...");
                    
                    const parts = data.reply.split('--- Wisdom:');
                    document.getElementById('response-text').innerText = parts[0];
                    
                    if(parts[1]) {
                        document.getElementById('wisdom-box').classList.remove('hidden');
                        document.getElementById('wisdom-text').innerText = "ğŸŒ± " + parts[1];
                    } else {
                        document.getElementById('wisdom-box').classList.add('hidden');
                    }

                    if(data.map_link) {
                        document.getElementById('map-wrap').classList.remove('hidden');
                        document.getElementById('google-map').src = data.map_link;
                    } else { 
                        document.getElementById('map-wrap').classList.add('hidden'); 
                    }

                    lastResponseText = data.reply;
                    lastResponseLang = data.voice_lang;
                    speak(data.reply, data.voice_lang);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    resetUI("Error connecting. Try again!");
                    document.getElementById('response-text').innerText = "Habibi encountered an error. Please try again.";
                });
        };

        // =====================================================================
        // ENHANCED SPEAK FUNCTION WITH CONTROLS
        // =====================================================================
        function speak(text, lang) {
            window.speechSynthesis.cancel();
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = lang;
            currentUtterance.volume = speechVolume;
            currentUtterance.rate = speechRate;
            
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('replay-btn').disabled = true;
            document.getElementById('speaking-indicator').classList.add('active');
            isSpeaking = true;
            
            currentUtterance.onend = () => {
                isSpeaking = false;
                document.getElementById('stop-btn').disabled = true;
                document.getElementById('replay-btn').disabled = false;
                document.getElementById('speaking-indicator').classList.remove('active');
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                isSpeaking = false;
                document.getElementById('stop-btn').disabled = true;
                document.getElementById('replay-btn').disabled = false;
                document.getElementById('speaking-indicator').classList.remove('active');
            };
            
            window.speechSynthesis.speak(currentUtterance);
        }

        // =====================================================================
        // STOP SPEAKING FUNCTION
        // =====================================================================
        function stopSpeaking() {
            window.speechSynthesis.cancel();
            isSpeaking = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('replay-btn').disabled = false;
            document.getElementById('speaking-indicator').classList.remove('active');
            console.log('ğŸ›‘ Speech stopped by user');
        }

        // =====================================================================
        // REPLAY LAST RESPONSE FUNCTION
        // =====================================================================
        function replaySpeech() {
            if (lastResponseText) {
                console.log('ğŸ” Replaying last response');
                speak(lastResponseText, lastResponseLang);
            }
        }

        // =====================================================================
        // FEEDBACK FUNCTION
        // =====================================================================
        function postFeedback() {
            const val = document.getElementById('feedback-in').value;
            if(val) {
                document.getElementById('ticker').innerText = `"${val}" - ` + document.getElementById('ticker').innerText;
                document.getElementById('feedback-in').value = "";
                alert("Mabrouk! Feedback shared with the world.");
            }
        }

        // =====================================================================
        // KEYBOARD SHORTCUTS
        // =====================================================================
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && event.target.tagName !== 'INPUT') {
                event.preventDefault();
                startSpeech();
            }
            if (event.code === 'Escape') {
                stopSpeaking();
            }
            if (event.code === 'KeyR' && !event.ctrlKey && event.target.tagName !== 'INPUT') {
                replaySpeech();
            }
        });

        console.log('ğŸ¤ Shortcuts: SPACE=Listen | ESC=Stop | R=Replay');
        console.log('ğŸš€ Share buttons ready! Help spread the word about Yalla Habibi AI');
    </script>

{% endblock %}
