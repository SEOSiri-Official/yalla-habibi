{% extends "base.html" %}

{% block title %}Yalla Habibi | Multilingual Voice Assistant{% endblock %}
{% block og_title %}Yalla Habibi â€“ Multilingual Voice Assistant{% endblock %}
{% block og_description %}Speak naturally. Get intelligent multilingual responses in 40+ languages.{% endblock %}

{% block content %}

<div class="glass-card">
  <header>
    <h1>Yalla <span>Habibi</span></h1>
    <p id="hook">"I am your Native Arabic host. How can I bridge your world today?"</p>

    <!-- Browser Compatibility Warning -->
    <div id="browser-warning" class="browser-warning" style="display:none;">
      âš ï¸ <strong>Limited Support:</strong> For best experience, use Chrome, Edge, or Safari.
      <button onclick="document.getElementById('browser-warning').style.display='none'" style="margin-left:10px;">âœ•</button>
    </div>

    <div class="pref-container">
      <label for="pref-lang">ğŸ—£ï¸ <strong>I want response in:</strong></label>
      <select id="pref-lang" aria-label="Select your preferred response language">
        <!-- Most Popular Languages (Top of List) -->
        <optgroup label="ğŸŒŸ Most Popular">
          <option value="en-US" selected>ğŸŒ English</option>
          <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
          <option value="bn-BD">ğŸ‡§ğŸ‡© Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
          <option value="hi-IN">ğŸ‡®ğŸ‡³ Hindi (à¤¹à¤¿à¤‚à¤¦à¥€)</option>
          <option value="es-ES">ğŸ‡ªğŸ‡¸ Spanish (EspaÃ±ol)</option>
          <option value="fr-FR">ğŸ‡«ğŸ‡· French (FranÃ§ais)</option>
          <option value="de-DE">ğŸ‡©ğŸ‡ª German (Deutsch)</option>
        </optgroup>
        
        <!-- Additional Major Languages -->
        <optgroup label="ğŸŒ Major Languages">
          <option value="pt-BR">ğŸ‡§ğŸ‡· Portuguese (PortuguÃªs)</option>
          <option value="ru-RU">ğŸ‡·ğŸ‡º Russian (Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
          <option value="ja-JP">ğŸ‡¯ğŸ‡µ Japanese (æ—¥æœ¬èª)</option>
          <option value="ko-KR">ğŸ‡°ğŸ‡· Korean (í•œêµ­ì–´)</option>
          <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese (ä¸­æ–‡)</option>
          <option value="it-IT">ğŸ‡®ğŸ‡¹ Italian (Italiano)</option>
          <option value="tr-TR">ğŸ‡¹ğŸ‡· Turkish (TÃ¼rkÃ§e)</option>
        </optgroup>
        
        <!-- Middle Eastern Languages -->
        <optgroup label="ğŸ•Œ Middle Eastern">
          <option value="ur-PK">ğŸ‡µğŸ‡° Urdu (Ø§Ø±Ø¯Ùˆ)</option>
          <option value="fa-IR">ğŸ‡®ğŸ‡· Persian (ÙØ§Ø±Ø³ÛŒ)</option>
          <option value="he-IL">ğŸ‡®ğŸ‡± Hebrew (×¢×‘×¨×™×ª)</option>
        </optgroup>
        
        <!-- South Asian Languages -->
        <optgroup label="ğŸ‡®ğŸ‡³ South Asian">
          <option value="ta-IN">Tamil (à®¤à®®à®¿à®´à¯)</option>
          <option value="te-IN">Telugu (à°¤à±†à°²à±à°—à±)</option>
          <option value="ml-IN">Malayalam (à´®à´²à´¯à´¾à´³à´‚)</option>
          <option value="mr-IN">Marathi (à¤®à¤°à¤¾à¤ à¥€)</option>
          <option value="gu-IN">Gujarati (àª—à«àªœàª°àª¾àª¤à«€)</option>
          <option value="kn-IN">Kannada (à²•à²¨à³à²¨à²¡)</option>
          <option value="pa-IN">Punjabi (à¨ªà©°à¨œà¨¾à¨¬à©€)</option>
        </optgroup>
        
        <!-- Southeast Asian Languages -->
        <optgroup label="ğŸŒ Southeast Asian">
          <option value="id-ID">ğŸ‡®ğŸ‡© Indonesian</option>
          <option value="ms-MY">ğŸ‡²ğŸ‡¾ Malay</option>
          <option value="th-TH">ğŸ‡¹ğŸ‡­ Thai (à¹„à¸—à¸¢)</option>
          <option value="vi-VN">ğŸ‡»ğŸ‡³ Vietnamese</option>
        </optgroup>
        
        <!-- European Languages -->
        <optgroup label="ğŸ‡ªğŸ‡º European">
          <option value="nl-NL">ğŸ‡³ğŸ‡± Dutch</option>
          <option value="pl-PL">ğŸ‡µğŸ‡± Polish</option>
          <option value="sv-SE">ğŸ‡¸ğŸ‡ª Swedish</option>
          <option value="no-NO">ğŸ‡³ğŸ‡´ Norwegian</option>
          <option value="da-DK">ğŸ‡©ğŸ‡° Danish</option>
          <option value="fi-FI">ğŸ‡«ğŸ‡® Finnish</option>
          <option value="el-GR">ğŸ‡¬ğŸ‡· Greek</option>
          <option value="cs-CZ">ğŸ‡¨ğŸ‡¿ Czech</option>
          <option value="hu-HU">ğŸ‡­ğŸ‡º Hungarian</option>
          <option value="ro-RO">ğŸ‡·ğŸ‡´ Romanian</option>
          <option value="uk-UA">ğŸ‡ºğŸ‡¦ Ukrainian</option>
        </optgroup>
        
        <!-- African Languages -->
        <optgroup label="ğŸŒ African">
          <option value="sw-KE">ğŸ‡°ğŸ‡ª Swahili</option>
          <option value="am-ET">ğŸ‡ªğŸ‡¹ Amharic</option>
        </optgroup>
      </select>
      
      <p class="lang-note">
        ğŸ’¡ <strong>Tip:</strong> Speak in ANY language - I'll understand! Select above for response language only.
      </p>
    </div>

    <div class="secondary-links">
      <a href="/manual" title="Learn how to use Yalla Habibi">ğŸ“˜ User Manual</a>
      <span class="divider">|</span>
      <a href="/api/languages" title="View all supported languages" target="_blank">ğŸŒ Language Info</a>
      <span class="divider">|</span>
      <a href="/api/browser-check" title="Check browser compatibility" target="_blank">ğŸ” Browser Check</a>
    </div>
  </header>

  <!-- DEMOGRAPHIC HINT SYMBOLS -->
  <div class="benefit-hints">
    <span>ğŸ‘·â€â™‚ï¸ Translation</span> â€¢ 
    <span>ğŸ“ Learning</span> â€¢ 
    <span>ğŸŒ Travel</span> â€¢ 
    <span>ğŸ—ºï¸ Navigation</span>
  </div>

  <!-- ===== VOICE CONTROLS SECTION ===== -->
  <div class="voice-controls">
    <h3>ğŸšï¸ Voice Controls</h3>
    <div class="voice-hint" id="voice-setup-hint">
      ğŸ’¡ <strong>Voice Setup:</strong> Enable language voices in your device settings for best experience. 
      <a href="/manual#voice-setup" target="_blank">Need help?</a>
    </div>

    <div class="control-group">
      <label for="volume-slider">
        ğŸ”Š Volume
        <span id="volume-value">100%</span>
      </label>
      <input 
        type="range" 
        min="0" 
        max="100" 
        value="100" 
        class="slider" 
        id="volume-slider"
        aria-label="Adjust volume"
      >
    </div>

    <div class="control-group">
      <label for="speed-slider">
        âš¡ Speed
        <span id="speed-value">Normal</span>
      </label>
      <input 
        type="range" 
        min="50" 
        max="200" 
        value="95" 
        class="slider" 
        id="speed-slider"
        aria-label="Adjust speaking speed"
      >
    </div>

    <div class="voice-action-buttons">
      <button 
        class="voice-btn stop" 
        id="stop-btn" 
        onclick="stopSpeaking()" 
        disabled
        aria-label="Stop speaking"
      >
        â¹ï¸ Stop
      </button>

      <button 
        class="voice-btn replay" 
        id="replay-btn" 
        onclick="replaySpeech()" 
        disabled
        aria-label="Replay last response"
      >
        ğŸ” Replay
      </button>
    </div>

    <div class="voice-action-buttons">
      <button 
        class="voice-btn pause" 
        id="pause-btn" 
        onclick="pauseSpeaking()" 
        disabled
        aria-label="Pause speaking"
      >
        â¸ï¸ Pause
      </button>

      <button 
        class="voice-btn resume" 
        id="resume-btn" 
        onclick="resumeSpeaking()" 
        disabled
        aria-label="Resume speaking"
      >
        â–¶ï¸ Resume
      </button>
    </div>

    <div class="speaking-indicator" id="speaking-indicator">
      <span>ğŸ”Š Speaking...</span>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
  </div>

  <!-- MAIN INTERACTION AREA -->
  <div class="main-body">
    <div id="status" role="status" aria-live="polite">
      {% if active_lang == "bn" %}
        à¦®à¦¾à¦‡à¦•à§à¦°à§‹à¦«à§‹à¦¨à§‡ à¦šà¦¾à¦ªà§à¦¨ à¦à¦¬à¦‚ à¦•à¦¥à¦¾ à¦¬à¦²à§à¦¨...
      {% elif active_lang == "ar" %}
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØªØ­Ø¯Ø«...
      {% elif active_lang == "hi" %}
        à¤®à¤¾à¤‡à¤•à¥à¤°à¥‹à¤«à¤¼à¥‹à¤¨ à¤¦à¤¬à¤¾à¤à¤‚ à¤”à¤° à¤¬à¥‹à¤²à¥‡à¤‚...
      {% elif active_lang == "ur" %}
        Ù…Ø§Ø¦ÛŒÚ© Ø¯Ø¨Ø§Ø¦ÛŒÚº Ø§ÙˆØ± Ø¨ÙˆÙ„ÛŒÚº...
      {% elif active_lang == "es" %}
        Presiona el micrÃ³fono y habla...
      {% elif active_lang == "fr" %}
        Appuyez sur le micro et parlez...
      {% elif active_lang == "de" %}
        DrÃ¼cken Sie das Mikrofon und sprechen Sie...
      {% else %}
        Press microphone and speak...
      {% endif %}
    </div>

    <button 
      id="mic-btn" 
      type="button"
      aria-label="Press to start speaking"
      title="Press and speak in any language (SPACE)"
    >
      <div class="pulse" id="pulse"></div>
      <span>ğŸ™ï¸</span>
    </button>

    <div id="user-transcript" aria-live="polite">...</div>

    <!-- AI Response Box -->
    <div class="ai-box">
      <div id="response-text">
        Marhaba! ğŸ‘‹ I understand 40+ languages. Speak naturally in YOUR language, and I'll respond in the language YOU choose above.
      </div>
      
      <p class="voice-hint">
        <strong>Examples:</strong><br>
        â€¢ Speak in Bangla, get response in English<br>
        â€¢ Speak in English, get response in Arabic<br>
        â€¢ Speak in Chinese, get response in Urdu<br>
        â€¢ Or speak and respond in the SAME language!
      </p>

      <div id="map-wrap" class="hidden">
        <iframe 
          id="google-map" 
          width="100%" 
          height="200" 
          src=""
          title="Location map"
          loading="lazy"
        ></iframe>
      </div>

      <div id="wisdom-box" class="hidden">
        <p id="wisdom-text"></p>
      </div>
    </div>
  </div>

  <!-- ===== SOCIAL SHARE SECTION ===== -->
  <div class="social-share-section">
    <div class="share-gpt">
      âœ¨ <strong>Try on ChatGPT:</strong>
      <a 
        href="https://chatgpt.com/g/g-698b641c04208191bb1c0f8861bac508-yalla-habibi-multilingual-voice-translation" 
        target="_blank"
        rel="noopener noreferrer"
      >
        Yalla Habibi GPT
      </a>
    </div>

    <h3>ğŸš€ Share Yalla Habibi</h3>
    <p class="share-subtitle">Help others discover this multilingual AI assistant!</p>

    <div class="share-buttons">
      <button class="share-btn facebook" onclick="shareOnFacebook()" aria-label="Share on Facebook">
        <span>ğŸ“˜ Facebook</span>
      </button>
      <button class="share-btn twitter" onclick="shareOnTwitter()" aria-label="Share on Twitter">
        <span>ğ• Twitter</span>
      </button>
      <button class="share-btn linkedin" onclick="shareOnLinkedIn()" aria-label="Share on LinkedIn">
        <span>ğŸ’¼ LinkedIn</span>
      </button>
      <button class="share-btn whatsapp" onclick="shareOnWhatsApp()" aria-label="Share on WhatsApp">
        <span>ğŸ’¬ WhatsApp</span>
      </button>
      <button class="share-btn telegram" onclick="shareOnTelegram()" aria-label="Share on Telegram">
        <span>âœˆï¸ Telegram</span>
      </button>
      <button class="share-btn reddit" onclick="shareOnReddit()" aria-label="Share on Reddit">
        <span>ğŸ¤– Reddit</span>
      </button>
    </div>

    <div class="copy-link-section">
      <input 
        type="text" 
        class="copy-link-input" 
        id="share-url" 
        readonly 
        value="https://yallahabibi.seosiri.com"
        aria-label="Share URL"
      >
      <button 
        class="copy-link-btn" 
        id="copy-btn" 
        onclick="copyShareLink()"
        aria-label="Copy link"
      >
        ğŸ“‹ Copy Link
      </button>
    </div>

    <div class="share-stats">
      Thank you for sharing! Every share helps grow our global community ğŸ’š
    </div>
  </div>

  <!-- COMMUNITY TICKER -->
  <div class="community-ticker">
    <div class="ticker-content" id="ticker">
      "Breaking language barriers worldwide..." - Join our multilingual community!
    </div>
  </div>

  <!-- FEEDBACK BOX -->
  <div class="feedback-box">
    <input 
      type="text" 
      id="feedback-in" 
      placeholder="Share your experience with Yalla Habibi..."
      aria-label="Feedback input"
      maxlength="200"
    >
    <button onclick="postFeedback()" aria-label="Post feedback">Post</button>
  </div>

  <footer>
    <div class="footer-content">
      <span class="made-in-badge">ğŸ‡§ğŸ‡© Made in Bangladesh</span>
      <span class="footer-divider">â€¢</span>
      <span>Created by <a href="https://www.seosiri.com/p/about.html" target="_blank" rel="noopener">Momenul Ahmad</a></span>
      <span class="footer-divider">â€¢</span>
      <span><a href="https://www.seosiri.com" target="_blank" rel="noopener">SEOSiri</a></span>
      <span class="footer-divider">â€¢</span>
      <span>40+ Languages</span>
    </div>
  </footer>
</div>

<script>
  // =====================================================================
  // STATE MANAGEMENT
  // =====================================================================
  let currentUtterance = null;
  let lastResponseText = "";
  let lastResponseLang = "en-US";
  let isSpeaking = false;
  let isPaused = false;

  let speechVolume = 1.0;
  let speechRate = 1.0;
  let recognitionActive = false;
  let detectedInputLang = null; // Track what language user spoke

  // =====================================================================
  // BROWSER COMPATIBILITY CHECK
  // =====================================================================
  function checkBrowserCompatibility() {
    const ua = navigator.userAgent.toLowerCase();
    const isChrome = ua.includes('chrome') && !ua.includes('edge');
    const isEdge = ua.includes('edge') || ua.includes('edg');
    const isSafari = ua.includes('safari') && !ua.includes('chrome');
    const isFirefox = ua.includes('firefox');
    
    console.log('ğŸŒ Browser Detection:', {
      chrome: isChrome,
      edge: isEdge,
      safari: isSafari,
      firefox: isFirefox
    });

    // Show warning for Firefox or unsupported browsers
    if (isFirefox || (!isChrome && !isEdge && !isSafari)) {
      document.getElementById('browser-warning').style.display = 'block';
    }

    return isChrome || isEdge || isSafari;
  }

  // =====================================================================
  // SHARE CONFIGURATION
  // =====================================================================
  const SHARE_CONFIG = {
    url: window.location.origin || "https://yallahabibi.seosiri.com",
    title: "Yalla Habibi â€“ Multilingual Voice Assistant",
    description: "Speak naturally with AI in 40+ languages"
  };

  const shareInput = document.getElementById('share-url');
  if (shareInput) shareInput.value = SHARE_CONFIG.url;

  function shareOnFacebook() {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_CONFIG.url)}`, 'fb-share', 'width=600,height=400');
  }
  function shareOnTwitter() {
    const text = encodeURIComponent(`ğŸ™ï¸ ${SHARE_CONFIG.title}\n${SHARE_CONFIG.url}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, 'twitter-share', 'width=600,height=400');
  }
  function shareOnLinkedIn() {
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_CONFIG.url)}`, 'linkedin-share', 'width=600,height=400');
  }
  function shareOnWhatsApp() {
    window.open(`https://wa.me/?text=${encodeURIComponent(SHARE_CONFIG.title + '\n' + SHARE_CONFIG.url)}`, 'whatsapp-share');
  }
  function shareOnTelegram() {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_CONFIG.url)}&text=${encodeURIComponent(SHARE_CONFIG.title)}`, 'telegram-share');
  }
  function shareOnReddit() {
    window.open(`https://reddit.com/submit?url=${encodeURIComponent(SHARE_CONFIG.url)}&title=${encodeURIComponent(SHARE_CONFIG.title)}`, 'reddit-share', 'width=800,height=600');
  }

  function copyShareLink() {
    const input = document.getElementById('share-url');
    input.select();
    navigator.clipboard.writeText(SHARE_CONFIG.url).then(() => {
      const btn = document.getElementById("copy-btn");
      btn.innerHTML = "âœ… Copied!";
      btn.style.background = "#10b981";
      setTimeout(() => {
        btn.innerHTML = "ğŸ“‹ Copy Link";
        btn.style.background = "";
      }, 2000);
    });
  }

  // =====================================================================
  // SPEECH RECOGNITION SETUP (NO AUTO-SWITCHING)
  // =====================================================================
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRec ? new SpeechRec() : null;

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    // IMPORTANT: Set to empty string for auto-detection
    recognition.lang = "";
  } else {
    console.warn('âš ï¸ Speech recognition not supported in this browser');
  }

  // =====================================================================
  // VOICE CONTROLS
  // =====================================================================
  const volumeSlider = document.getElementById('volume-slider');
  const speedSlider = document.getElementById('speed-slider');
  const volumeValue = document.getElementById('volume-value');
  const speedValue = document.getElementById('speed-value');

  function mapVolume(sliderVal) {
    const x = Math.max(0, Math.min(100, sliderVal)) / 100;
    return Math.pow(x, 1.8);
  }

  function mapRate(sliderVal) {
    const v = Math.max(50, Math.min(200, sliderVal));
    const t = (v - 50) / 150;
    const eased = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2)/2;
    return 0.75 + eased * 0.75;
  }

  function updateSpeedLabel(raw) {
    const v = Number(raw);
    speedValue.textContent = v < 80 ? "Slow" : v < 115 ? "Normal" : "Fast";
  }

  function updateVolumeLabel(raw) {
    volumeValue.textContent = `${raw}%`;
  }

  speechVolume = mapVolume(Number(volumeSlider.value));
  speechRate = mapRate(Number(speedSlider.value));
  updateVolumeLabel(volumeSlider.value);
  updateSpeedLabel(speedSlider.value);

  volumeSlider.addEventListener('input', function() {
    speechVolume = mapVolume(Number(this.value));
    updateVolumeLabel(this.value);
    if (currentUtterance && isSpeaking) currentUtterance.volume = speechVolume;
  });

  speedSlider.addEventListener('input', function() {
    speechRate = mapRate(Number(this.value));
    updateSpeedLabel(this.value);
    if (currentUtterance && isSpeaking) currentUtterance.rate = speechRate;
  });

  // =====================================================================
  // UI HELPERS
  // =====================================================================
  function resetUI(message = "Press microphone and speak...") {
    document.getElementById('pulse').style.display = 'none';
    document.getElementById('status').innerText = message;
    document.getElementById('mic-btn').classList.remove('recording');
  }

  function setSpeakingUI(active) {
    const stopBtn = document.getElementById('stop-btn');
    const replayBtn = document.getElementById('replay-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const indicator = document.getElementById('speaking-indicator');

    if (active) {
      stopBtn.disabled = false;
      replayBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      indicator.classList.add('active');
    } else {
      stopBtn.disabled = true;
      replayBtn.disabled = !lastResponseText;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      indicator.classList.remove('active');
    }
  }

  function setPausedUI(paused) {
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    
    if (paused) {
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    } else {
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
    }
  }

  // =====================================================================
  // MICROPHONE BUTTON
  // =====================================================================
  const micBtn = document.getElementById('mic-btn');

  micBtn.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    startSpeech();
  }, { passive: false });

  // =====================================================================
  // RECOGNITION HANDLERS (NO AUTO-SWITCHING!)
  // =====================================================================
  if (recognition) {
    recognition.onstart = () => {
      recognitionActive = true;
      document.getElementById('pulse').style.display = 'block';
      document.getElementById('status').innerText = "ğŸ¤ Listening... (Speak in any language)";
      document.getElementById('mic-btn').classList.add('recording');
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      recognitionActive = false;
      
      const errorMessages = {
        'no-speech': 'No speech detected. Please try again.',
        'audio-capture': 'Microphone error. Check permissions.',
        'not-allowed': 'Microphone permission denied.',
        'network': 'Network error. Check connection.'
      };
      
      resetUI(errorMessages[event.error] || `Error: ${event.error}`);
    };

    recognition.onend = () => {
      recognitionActive = false;
      if (document.getElementById('status').innerText.includes("Listening")) {
        resetUI("No speech detected. Try again!");
      }
    };

    recognition.onresult = (event) => {
      const result = event.results[0][0];
      const text = result.transcript || "";
      const detectedLang = result.lang || event.results[0].lang || "";
      
      // Store detected language but DON'T auto-switch dropdown
      detectedInputLang = detectedLang;
      
      // Get MANUALLY selected output language
      const outputLang = document.getElementById('pref-lang').value;

      console.log('ğŸ¤ Input detected:', text);
      console.log('ğŸ—£ï¸ Detected language:', detectedInputLang);
      console.log('ğŸ“¤ Response language:', outputLang);

      document.getElementById('user-transcript').innerText = `You said: "${text}"`;
      document.getElementById('status').innerText = "âš™ï¸ Processing...";
      document.getElementById('pulse').style.display = 'none';

      // Build API URL with both input and output language
      let apiUrl = `/api/chat?user_input=${encodeURIComponent(text)}&pref=${encodeURIComponent(outputLang)}`;
      if (detectedInputLang) {
        apiUrl += `&input_lang=${encodeURIComponent(detectedInputLang)}`;
      }

      fetch(apiUrl)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(data => {
          resetUI("âœ… Response ready! Speak again...");

          const parts = (data.reply || "").split('--- Wisdom:');
          document.getElementById('response-text').innerText = parts[0] || "";

          if (parts[1]) {
            document.getElementById('wisdom-box').classList.remove('hidden');
            document.getElementById('wisdom-text').innerText = "ğŸŒ± " + parts[1].trim();
          } else {
            document.getElementById('wisdom-box').classList.add('hidden');
          }

          if (data.map_link) {
            document.getElementById('map-wrap').classList.remove('hidden');
            document.getElementById('google-map').src = data.map_link;
          } else {
            document.getElementById('map-wrap').classList.add('hidden');
          }

          lastResponseText = data.reply || "";
          lastResponseLang = data.voice_lang || outputLang;

          // Show support level info
          if (data.support_level === 'limited') {
            console.warn('âš ï¸ Limited TTS support for:', lastResponseLang);
            document.getElementById('voice-setup-hint').style.display = 'block';
          }

          speak(lastResponseText, lastResponseLang);
        })
        .catch(error => {
          console.error('API error:', error);
          resetUI("âŒ Connection error. Try again!");
          document.getElementById('response-text').innerText = "Error connecting to server. Please check your internet and try again.";
        });
    };
  }

  function startSpeech() {
    if (!recognition) {
      alert("âš ï¸ Speech recognition not supported.\n\nPlease use:\nâ€¢ Chrome\nâ€¢ Edge\nâ€¢ Safari\n\nFirefox has limited support.");
      return;
    }

    if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
      window.speechSynthesis.cancel();
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
    }

    if (recognitionActive) return;

    try {
      // Set to empty for auto-detection of ANY language
      recognition.lang = "";
      recognition.start();
    } catch (e) {
      console.error('Recognition start error:', e);
      resetUI("Microphone busy. Try again.");
    }
  }

  // =====================================================================
  // TEXT-TO-SPEECH
  // =====================================================================
  function speak(text, lang) {
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.volume = speechVolume;
    utterance.rate = speechRate;

    const voices = window.speechSynthesis.getVoices();
    let selectedVoice = voices.find(v => v.lang === lang);

    if (!selectedVoice) {
      const prefix = lang.split('-')[0];
      selectedVoice = voices.find(v => v.lang.startsWith(prefix));
    }

    if (selectedVoice) {
      utterance.voice = selectedVoice;
      console.log("âœ… Voice:", selectedVoice.name);
      document.getElementById('voice-setup-hint').style.display = 'none';
    } else {
      console.warn("âš ï¸ No native voice for:", lang);
      document.getElementById('voice-setup-hint').style.display = 'block';
    }

    currentUtterance = utterance;
    isSpeaking = true;
    setSpeakingUI(true);

    utterance.onend = () => {
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
    };

    utterance.onerror = (e) => {
      console.error('Speech error:', e);
      isSpeaking = false;
      setSpeakingUI(false);
    };

    window.speechSynthesis.speak(utterance);
  }

  function pauseSpeaking() {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
      window.speechSynthesis.pause();
      isPaused = true;
      setPausedUI(true);
    }
  }

  function resumeSpeaking() {
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
      isPaused = false;
      setPausedUI(false);
    }
  }

  function stopSpeaking() {
    window.speechSynthesis.cancel();
    isSpeaking = false;
    isPaused = false;
    setSpeakingUI(false);
    setPausedUI(false);
  }

  function replaySpeech() {
    if (lastResponseText) {
      speak(lastResponseText, lastResponseLang);
    }
  }

  // =====================================================================
  // FEEDBACK
  // =====================================================================
  function postFeedback() {
    const input = document.getElementById('feedback-in');
    const val = input.value.trim();
    
    if (val) {
      const ticker = document.getElementById('ticker');
      ticker.innerText = `"${val}" - ${ticker.innerText}`;
      input.value = "";
      input.style.borderColor = "#10b981";
      setTimeout(() => input.style.borderColor = "", 1000);
    } else {
      alert("Please write your feedback!");
    }
  }

  // =====================================================================
  // KEYBOARD SHORTCUTS
  // =====================================================================
  document.addEventListener('keydown', function(event) {
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

    if (event.code === 'Space') {
      event.preventDefault();
      startSpeech();
    }
    if (event.code === 'Escape') stopSpeaking();
    if (event.code === 'KeyR' && !event.ctrlKey) replaySpeech();
    if (event.code === 'KeyP' && !event.ctrlKey) {
      if (window.speechSynthesis.paused) resumeSpeaking();
      else if (window.speechSynthesis.speaking) pauseSpeaking();
    }
  });

  // =====================================================================
  // INITIALIZATION
  // =====================================================================
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => {
      console.log(`ğŸ”Š ${window.speechSynthesis.getVoices().length} voices loaded`);
    };
  }

  // Check browser compatibility on load
  checkBrowserCompatibility();

  console.log('ğŸ™ï¸ Yalla Habibi initialized');
  console.log('âŒ¨ï¸ Shortcuts: SPACE=Listen | ESC=Stop | R=Replay | P=Pause/Resume');
  console.log('ğŸŒ Speak in ANY language, get response in YOUR selected language!');
</script>

<style>
.browser-warning {
  background: #fef3c7;
  color: #92400e;
  padding: 12px;
  border-radius: 12px;
  margin: 10px 0;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.browser-warning button {
  background: transparent;
  border: none;
  color: #92400e;
  font-size: 18px;
  cursor: pointer;
  padding: 0 8px;
}

.lang-note {
  margin-top: 8px;
  font-size: 13px;
  color: #4ade80;
  font-style: italic;
}

.secondary-links .divider {
  color: #4ade80;
  margin: 0 8px;
}
</style>

{% endblock %}