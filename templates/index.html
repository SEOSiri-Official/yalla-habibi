{% extends "base.html" %}

{% block title %}Yalla Habibi | Multilingual Voice Assistant{% endblock %}
{% block og_title %}Yalla Habibi â€“ Multilingual Voice Assistant{% endblock %}
{% block og_description %}Speak naturally. Get intelligent multilingual responses automatically.{% endblock %}

{% block content %}

<div class="glass-card">
  <header>
    <h1>Yalla <span>Habibi</span></h1>
    <p id="hook">"Speak in your language, I'll understand and respond naturally!"</p>

    <div class="pref-container">
      <label for="mode-select">ğŸ¯ <strong>Translation Mode:</strong></label>
      <select id="mode-select" aria-label="Select mode">
        <option value="auto" selected>ğŸ¤– Auto (Same Language)</option>
        <option value="translate">ğŸŒ Translate to Different Language</option>
      </select>
    </div>

    <!-- Translation Language Selector (Hidden by default) -->
    <div class="pref-container" id="translate-selector" style="display:none;">
      <label for="pref-lang">ğŸ“¢ <strong>Translate my speech to:</strong></label>
      <select id="pref-lang" aria-label="Select translation language">
        <optgroup label="ğŸŒŸ Most Popular">
          <option value="en-US">ğŸŒ English</option>
          <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
          <option value="bn-BD">ğŸ‡§ğŸ‡© Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
          <option value="hi-IN">ğŸ‡®ğŸ‡³ Hindi (à¤¹à¤¿à¤‚à¤¦à¥€)</option>
          <option value="es-ES">ğŸ‡ªğŸ‡¸ Spanish (EspaÃ±ol)</option>
          <option value="fr-FR">ğŸ‡«ğŸ‡· French (FranÃ§ais)</option>
          <option value="de-DE">ğŸ‡©ğŸ‡ª German (Deutsch)</option>
        </optgroup>
        
        <optgroup label="ğŸŒ Major Languages">
          <option value="pt-BR">ğŸ‡§ğŸ‡· Portuguese</option>
          <option value="ru-RU">ğŸ‡·ğŸ‡º Russian</option>
          <option value="ja-JP">ğŸ‡¯ğŸ‡µ Japanese</option>
          <option value="ko-KR">ğŸ‡°ğŸ‡· Korean</option>
          <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese</option>
          <option value="it-IT">ğŸ‡®ğŸ‡¹ Italian</option>
          <option value="tr-TR">ğŸ‡¹ğŸ‡· Turkish</option>
        </optgroup>
        
        <optgroup label="ğŸ•Œ Middle Eastern">
          <option value="ur-PK">ğŸ‡µğŸ‡° Urdu</option>
          <option value="fa-IR">ğŸ‡®ğŸ‡· Persian</option>
          <option value="he-IL">ğŸ‡®ğŸ‡± Hebrew</option>
        </optgroup>
        
        <optgroup label="ğŸ‡®ğŸ‡³ South Asian">
          <option value="ta-IN">Tamil</option>
          <option value="te-IN">Telugu</option>
          <option value="ml-IN">Malayalam</option>
          <option value="mr-IN">Marathi</option>
          <option value="gu-IN">Gujarati</option>
          <option value="kn-IN">Kannada</option>
          <option value="pa-IN">Punjabi</option>
        </optgroup>
        
        <optgroup label="ğŸŒ Southeast Asian">
          <option value="id-ID">ğŸ‡®ğŸ‡© Indonesian</option>
          <option value="ms-MY">ğŸ‡²ğŸ‡¾ Malay</option>
          <option value="th-TH">ğŸ‡¹ğŸ‡­ Thai</option>
          <option value="vi-VN">ğŸ‡»ğŸ‡³ Vietnamese</option>
        </optgroup>
        
        <optgroup label="ğŸ‡ªğŸ‡º European">
          <option value="nl-NL">ğŸ‡³ğŸ‡± Dutch</option>
          <option value="pl-PL">ğŸ‡µğŸ‡± Polish</option>
          <option value="sv-SE">ğŸ‡¸ğŸ‡ª Swedish</option>
          <option value="no-NO">ğŸ‡³ğŸ‡´ Norwegian</option>
          <option value="da-DK">ğŸ‡©ğŸ‡° Danish</option>
          <option value="fi-FI">ğŸ‡«ğŸ‡® Finnish</option>
          <option value="el-GR">ğŸ‡¬ğŸ‡· Greek</option>
          <option value="cs-CZ">ğŸ‡¨ğŸ‡¿ Czech</option>
          <option value="hu-HU">ğŸ‡­ğŸ‡º Hungarian</option>
          <option value="ro-RO">ğŸ‡·ğŸ‡´ Romanian</option>
          <option value="uk-UA">ğŸ‡ºğŸ‡¦ Ukrainian</option>
        </optgroup>
        
        <optgroup label="ğŸŒ African">
          <option value="sw-KE">ğŸ‡°ğŸ‡ª Swahili</option>
          <option value="am-ET">ğŸ‡ªğŸ‡¹ Amharic</option>
        </optgroup>
      </select>
    </div>

    <div class="secondary-links">
      <a href="/manual" title="Learn how to use Yalla Habibi">ğŸ“˜ User Manual</a>
    </div>
  </header>

  <!-- MODE EXPLANATION -->
  <div class="benefit-hints" id="mode-hint">
    <span id="mode-explanation">ğŸ¤– Auto Mode: Speak Bengali â†’ Hear Bengali | Speak English â†’ Hear English</span>
  </div>

  <!-- ===== VOICE CONTROLS SECTION ===== -->
  <div class="voice-controls">
    <h3>ğŸšï¸ Voice Controls</h3>

    <div class="control-group">
      <label for="volume-slider">
        ğŸ”Š Volume
        <span id="volume-value">100%</span>
      </label>
      <input 
        type="range" 
        min="0" 
        max="100" 
        value="100" 
        class="slider" 
        id="volume-slider"
        aria-label="Adjust volume"
      >
    </div>

    <div class="control-group">
      <label for="speed-slider">
        âš¡ Speed
        <span id="speed-value">Normal</span>
      </label>
      <input 
        type="range" 
        min="50" 
        max="200" 
        value="95" 
        class="slider" 
        id="speed-slider"
        aria-label="Adjust speaking speed"
      >
    </div>

    <div class="voice-action-buttons">
      <button 
        class="voice-btn stop" 
        id="stop-btn" 
        onclick="stopSpeaking()" 
        disabled
        aria-label="Stop speaking"
      >
        â¹ï¸ Stop
      </button>

      <button 
        class="voice-btn replay" 
        id="replay-btn" 
        onclick="replaySpeech()" 
        disabled
        aria-label="Replay last response"
      >
        ğŸ” Replay
      </button>
    </div>

    <div class="voice-action-buttons">
      <button 
        class="voice-btn pause" 
        id="pause-btn" 
        onclick="pauseSpeaking()" 
        disabled
        aria-label="Pause speaking"
      >
        â¸ï¸ Pause
      </button>

      <button 
        class="voice-btn resume" 
        id="resume-btn" 
        onclick="resumeSpeaking()" 
        disabled
        aria-label="Resume speaking"
      >
        â–¶ï¸ Resume
      </button>
    </div>

    <div class="speaking-indicator" id="speaking-indicator">
      <span>ğŸ”Š Speaking...</span>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
  </div>

  <!-- MAIN INTERACTION AREA -->
  <div class="main-body">
    <div id="status" role="status" aria-live="polite">
      {% if active_lang == "bn" %}
        à¦®à¦¾à¦‡à¦•à§à¦°à§‹à¦«à§‹à¦¨à§‡ à¦šà¦¾à¦ªà§à¦¨ à¦à¦¬à¦‚ à¦¬à¦¾à¦‚à¦²à¦¾à¦¯à¦¼ à¦•à¦¥à¦¾ à¦¬à¦²à§à¦¨...
      {% elif active_lang == "ar" %}
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØªØ­Ø¯Ø« Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©...
      {% elif active_lang == "hi" %}
        à¤®à¤¾à¤‡à¤•à¥à¤°à¥‹à¤«à¤¼à¥‹à¤¨ à¤¦à¤¬à¤¾à¤à¤‚ à¤”à¤° à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤¬à¥‹à¤²à¥‡à¤‚...
      {% elif active_lang == "ur" %}
        Ù…Ø§Ø¦ÛŒÚ© Ø¯Ø¨Ø§Ø¦ÛŒÚº Ø§ÙˆØ± Ø§Ø±Ø¯Ùˆ Ù…ÛŒÚº Ø¨ÙˆÙ„ÛŒÚº...
      {% else %}
        Press microphone and speak naturally...
      {% endif %}
    </div>

    <button 
      id="mic-btn" 
      type="button"
      aria-label="Press to start speaking"
      title="Press and speak in your language (SPACE)"
    >
      <div class="pulse" id="pulse"></div>
      <span>ğŸ™ï¸</span>
    </button>

    <div id="user-transcript" aria-live="polite">...</div>

    <!-- AI Response Box -->
    <div class="ai-box">
      <div id="response-text">
        Marhaba! ğŸ‘‹ Speak in YOUR language - I'll understand and respond naturally!
      </div>
      
      <p class="voice-hint">
        <strong>Try it:</strong><br>
        â€¢ Speak in Bangla â†’ Get response in Bangla<br>
        â€¢ Need translation? Switch to Translation Mode above!
      </p>

      <div id="map-wrap" class="hidden">
        <iframe 
          id="google-map" 
          width="100%" 
          height="200" 
          src=""
          title="Location map"
          loading="lazy"
        ></iframe>
      </div>

      <div id="wisdom-box" class="hidden">
        <p id="wisdom-text"></p>
      </div>
    </div>
  </div>

  <!-- ===== SOCIAL SHARE SECTION ===== -->
  <div class="social-share-section">
    <div class="share-gpt">
      âœ¨ <strong>Try on ChatGPT:</strong>
      <a 
        href="https://chatgpt.com/g/g-698b641c04208191bb1c0f8861bac508-yalla-habibi-multilingual-voice-translation" 
        target="_blank"
        rel="noopener noreferrer"
      >
        Yalla Habibi GPT
      </a>
    </div>

    <h3>ğŸš€ Share Yalla Habibi</h3>
    <p class="share-subtitle">Help others discover this multilingual AI assistant!</p>

    <div class="share-buttons">
      <button class="share-btn facebook" onclick="shareOnFacebook()" aria-label="Share on Facebook">
        <span>ğŸ“˜ Facebook</span>
      </button>
      <button class="share-btn twitter" onclick="shareOnTwitter()" aria-label="Share on Twitter">
        <span>ğ• Twitter</span>
      </button>
      <button class="share-btn linkedin" onclick="shareOnLinkedIn()" aria-label="Share on LinkedIn">
        <span>ğŸ’¼ LinkedIn</span>
      </button>
      <button class="share-btn whatsapp" onclick="shareOnWhatsApp()" aria-label="Share on WhatsApp">
        <span>ğŸ’¬ WhatsApp</span>
      </button>
      <button class="share-btn telegram" onclick="shareOnTelegram()" aria-label="Share on Telegram">
        <span>âœˆï¸ Telegram</span>
      </button>
      <button class="share-btn reddit" onclick="shareOnReddit()" aria-label="Share on Reddit">
        <span>ğŸ¤– Reddit</span>
      </button>
    </div>

    <div class="copy-link-section">
      <input 
        type="text" 
        class="copy-link-input" 
        id="share-url" 
        readonly 
        value="https://yallahabibi.seosiri.com"
        aria-label="Share URL"
      >
      <button 
        class="copy-link-btn" 
        id="copy-btn" 
        onclick="copyShareLink()"
        aria-label="Copy link"
      >
        ğŸ“‹ Copy Link
      </button>
    </div>

    <div class="share-stats">
      Thank you for sharing! Every share helps grow our global community ğŸ’š
    </div>
  </div>

  <!-- COMMUNITY TICKER -->
  <div class="community-ticker">
    <div class="ticker-content" id="ticker">
      "Breaking language barriers worldwide..." - Join our multilingual community!
    </div>
  </div>

  <!-- FEEDBACK BOX -->
  <div class="feedback-box">
    <input 
      type="text" 
      id="feedback-in" 
      placeholder="Share your experience with Yalla Habibi..."
      aria-label="Feedback input"
      maxlength="200"
    >
    <button onclick="postFeedback()" aria-label="Post feedback">Post</button>
  </div>

  <footer>
    <div class="footer-content">
      <span class="made-in-badge">ğŸ‡§ğŸ‡© Made in Bangladesh</span>
      <span class="footer-divider">â€¢</span>
      <span>Created by <a href="https://www.seosiri.com/p/about.html" target="_blank" rel="noopener">Momenul Ahmad</a></span>
      <span class="footer-divider">â€¢</span>
      <span><a href="https://www.seosiri.com" target="_blank" rel="noopener">SEOSiri</a></span>
      <span class="footer-divider">â€¢</span>
      <span>40+ Languages</span>
    </div>
  </footer>
</div>

<script>
  // =====================================================================
  // STATE MANAGEMENT
  // =====================================================================
  let currentUtterance = null;
  let lastResponseText = "";
  let lastResponseLang = "en-US";
  let isSpeaking = false;
  let isPaused = false;

  let speechVolume = 1.0;
  let speechRate = 1.0;
  let recognitionActive = false;
  let detectedInputLang = null;

  // =====================================================================
  // MODE TOGGLE
  // =====================================================================
  const modeSelect = document.getElementById('mode-select');
  const translateSelector = document.getElementById('translate-selector');
  const modeExplanation = document.getElementById('mode-explanation');

  modeSelect.addEventListener('change', function() {
    if (this.value === 'translate') {
      translateSelector.style.display = 'block';
      modeExplanation.textContent = 'ğŸŒ Translation Mode: Speak in any language, get response in selected language';
    } else {
      translateSelector.style.display = 'none';
      modeExplanation.textContent = 'ğŸ¤– Auto Mode: Speak Bengali â†’ Hear Bengali | Speak English â†’ Hear English';
    }
  });

  // =====================================================================
  // SHARE CONFIGURATION
  // =====================================================================
  const SHARE_CONFIG = {
    url: window.location.origin || "https://yallahabibi.seosiri.com",
    title: "Yalla Habibi â€“ Multilingual Voice Assistant",
    description: "Speak naturally with AI in 40+ languages"
  };

  const shareInput = document.getElementById('share-url');
  if (shareInput) shareInput.value = SHARE_CONFIG.url;

  function shareOnFacebook() {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_CONFIG.url)}`, 'fb-share', 'width=600,height=400');
  }
  function shareOnTwitter() {
    const text = encodeURIComponent(`ğŸ™ï¸ ${SHARE_CONFIG.title}\n${SHARE_CONFIG.url}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, 'twitter-share', 'width=600,height=400');
  }
  function shareOnLinkedIn() {
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_CONFIG.url)}`, 'linkedin-share', 'width=600,height=400');
  }
  function shareOnWhatsApp() {
    window.open(`https://wa.me/?text=${encodeURIComponent(SHARE_CONFIG.title + '\n' + SHARE_CONFIG.url)}`, 'whatsapp-share');
  }
  function shareOnTelegram() {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_CONFIG.url)}&text=${encodeURIComponent(SHARE_CONFIG.title)}`, 'telegram-share');
  }
  function shareOnReddit() {
    window.open(`https://reddit.com/submit?url=${encodeURIComponent(SHARE_CONFIG.url)}&title=${encodeURIComponent(SHARE_CONFIG.title)}`, 'reddit-share', 'width=800,height=600');
  }

  function copyShareLink() {
    const input = document.getElementById('share-url');
    input.select();
    navigator.clipboard.writeText(SHARE_CONFIG.url).then(() => {
      const btn = document.getElementById("copy-btn");
      btn.innerHTML = "âœ… Copied!";
      btn.style.background = "#10b981";
      setTimeout(() => {
        btn.innerHTML = "ğŸ“‹ Copy Link";
        btn.style.background = "";
      }, 2000);
    });
  }

  // =====================================================================
  // SPEECH RECOGNITION SETUP
  // =====================================================================
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRec ? new SpeechRec() : null;

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.lang = ""; // Auto-detect
  } else {
    console.warn('âš ï¸ Speech recognition not supported');
  }

  // =====================================================================
  // VOICE CONTROLS
  // =====================================================================
  const volumeSlider = document.getElementById('volume-slider');
  const speedSlider = document.getElementById('speed-slider');
  const volumeValue = document.getElementById('volume-value');
  const speedValue = document.getElementById('speed-value');

  function mapVolume(sliderVal) {
    const x = Math.max(0, Math.min(100, sliderVal)) / 100;
    return Math.pow(x, 1.8);
  }

  function mapRate(sliderVal) {
    const v = Math.max(50, Math.min(200, sliderVal));
    const t = (v - 50) / 150;
    const eased = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2)/2;
    return 0.75 + eased * 0.75;
  }

  function updateSpeedLabel(raw) {
    const v = Number(raw);
    speedValue.textContent = v < 80 ? "Slow" : v < 115 ? "Normal" : "Fast";
  }

  function updateVolumeLabel(raw) {
    volumeValue.textContent = `${raw}%`;
  }

  speechVolume = mapVolume(Number(volumeSlider.value));
  speechRate = mapRate(Number(speedSlider.value));
  updateVolumeLabel(volumeSlider.value);
  updateSpeedLabel(speedSlider.value);

  volumeSlider.addEventListener('input', function() {
    speechVolume = mapVolume(Number(this.value));
    updateVolumeLabel(this.value);
    if (currentUtterance && isSpeaking) currentUtterance.volume = speechVolume;
  });

  speedSlider.addEventListener('input', function() {
    speechRate = mapRate(Number(this.value));
    updateSpeedLabel(this.value);
    if (currentUtterance && isSpeaking) currentUtterance.rate = speechRate;
  });

  // =====================================================================
  // UI HELPERS
  // =====================================================================
  function resetUI(message = "Press microphone and speak...") {
    document.getElementById('pulse').style.display = 'none';
    document.getElementById('status').innerText = message;
    document.getElementById('mic-btn').classList.remove('recording');
  }

  function setSpeakingUI(active) {
    const stopBtn = document.getElementById('stop-btn');
    const replayBtn = document.getElementById('replay-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const indicator = document.getElementById('speaking-indicator');

    if (active) {
      stopBtn.disabled = false;
      replayBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      indicator.classList.add('active');
    } else {
      stopBtn.disabled = true;
      replayBtn.disabled = !lastResponseText;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      indicator.classList.remove('active');
    }
  }

  function setPausedUI(paused) {
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    
    if (paused) {
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    } else {
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
    }
  }

  // =====================================================================
  // MICROPHONE BUTTON
  // =====================================================================
  const micBtn = document.getElementById('mic-btn');

  micBtn.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    startSpeech();
  }, { passive: false });

  // =====================================================================
  // RECOGNITION HANDLERS (AUTO MODE)
  // =====================================================================
  if (recognition) {
    recognition.onstart = () => {
      recognitionActive = true;
      document.getElementById('pulse').style.display = 'block';
      document.getElementById('status').innerText = "ğŸ¤ Listening...";
      document.getElementById('mic-btn').classList.add('recording');
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      recognitionActive = false;
      
      const errorMessages = {
        'no-speech': 'No speech detected. Please try again.',
        'audio-capture': 'Microphone error. Check permissions.',
        'not-allowed': 'Microphone permission denied.',
        'network': 'Network error. Check connection.'
      };
      
      resetUI(errorMessages[event.error] || `Error: ${event.error}`);
    };

    recognition.onend = () => {
      recognitionActive = false;
      if (document.getElementById('status').innerText.includes("Listening")) {
        resetUI("No speech detected. Try again!");
      }
    };

    recognition.onresult = (event) => {
      const result = event.results[0][0];
      const text = result.transcript || "";
      detectedInputLang = result.lang || "";

      console.log('ğŸ¤ You said:', text);
      console.log('ğŸ—£ï¸ Detected language:', detectedInputLang);

      const mode = modeSelect.value;
      let outputLang;

      if (mode === 'auto') {
        // AUTO MODE: Same language
        outputLang = detectedInputLang || 'en-US';
        console.log('ğŸ¤– Auto Mode: Responding in', outputLang);
      } else {
        // TRANSLATION MODE: Different language
        outputLang = document.getElementById('pref-lang').value;
        console.log('ğŸŒ Translation Mode: Translating to', outputLang);
      }

      document.getElementById('user-transcript').innerText = `You: "${text}"`;
      document.getElementById('status').innerText = "âš™ï¸ Processing...";
      document.getElementById('pulse').style.display = 'none';

      // Build API URL
      let apiUrl = `/api/chat?user_input=${encodeURIComponent(text)}`;
      if (mode === 'translate') {
        apiUrl += `&pref=${encodeURIComponent(outputLang)}`;
      }
      if (detectedInputLang) {
        apiUrl += `&detected_lang=${encodeURIComponent(detectedInputLang)}`;
      }

      fetch(apiUrl)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(data => {
          resetUI("âœ… Response ready! Speak again...");

          const parts = (data.reply || "").split('--- Wisdom:');
          document.getElementById('response-text').innerText = parts[0] || "";

          if (parts[1]) {
            document.getElementById('wisdom-box').classList.remove('hidden');
            document.getElementById('wisdom-text').innerText = "ğŸŒ± " + parts[1].trim();
          } else {
            document.getElementById('wisdom-box').classList.add('hidden');
          }

          if (data.map_link) {
            document.getElementById('map-wrap').classList.remove('hidden');
            document.getElementById('google-map').src = data.map_link;
          } else {
            document.getElementById('map-wrap').classList.add('hidden');
          }

          lastResponseText = data.reply || "";
          lastResponseLang = data.voice_lang || outputLang;

          console.log('ğŸ“¢ Speaking in:', lastResponseLang);
          speak(lastResponseText, lastResponseLang);
        })
        .catch(error => {
          console.error('API error:', error);
          resetUI("âŒ Connection error. Try again!");
          document.getElementById('response-text').innerText = "Error connecting. Please check your internet and try again.";
        });
    };
  }

  function startSpeech() {
    if (!recognition) {
      alert("âš ï¸ Speech recognition not supported.\n\nPlease use Chrome, Edge, or Safari.");
      return;
    }

    if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
      window.speechSynthesis.cancel();
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
    }

    if (recognitionActive) return;

    try {
      recognition.lang = "";
      recognition.start();
    } catch (e) {
      console.error('Recognition error:', e);
      resetUI("Microphone busy. Try again.");
    }
  }

  // =====================================================================
  // TEXT-TO-SPEECH
  // =====================================================================
  function speak(text, lang) {
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.volume = speechVolume;
    utterance.rate = speechRate;

    const voices = window.speechSynthesis.getVoices();
    let selectedVoice = voices.find(v => v.lang === lang);

    if (!selectedVoice) {
      const prefix = lang.split('-')[0];
      selectedVoice = voices.find(v => v.lang.startsWith(prefix));
    }

    if (selectedVoice) {
      utterance.voice = selectedVoice;
      console.log("âœ… Voice:", selectedVoice.name);
    } else {
      console.warn("âš ï¸ No native voice for:", lang);
    }

    currentUtterance = utterance;
    isSpeaking = true;
    setSpeakingUI(true);

    utterance.onend = () => {
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
    };

    utterance.onerror = (e) => {
      console.error('Speech error:', e);
      isSpeaking = false;
      setSpeakingUI(false);
    };

    window.speechSynthesis.speak(utterance);
  }

  function pauseSpeaking() {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
      window.speechSynthesis.pause();
      isPaused = true;
      setPausedUI(true);
    }
  }

  function resumeSpeaking() {
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
      isPaused = false;
      setPausedUI(false);
    }
  }

  function stopSpeaking() {
    window.speechSynthesis.cancel();
    isSpeaking = false;
    isPaused = false;
    setSpeakingUI(false);
    setPausedUI(false);
  }

  function replaySpeech() {
    if (lastResponseText) {
      speak(lastResponseText, lastResponseLang);
    }
  }

  // =====================================================================
  // FEEDBACK
  // =====================================================================
  function postFeedback() {
    const input = document.getElementById('feedback-in');
    const val = input.value.trim();
    
    if (val) {
      const ticker = document.getElementById('ticker');
      ticker.innerText = `"${val}" - ${ticker.innerText}`;
      input.value = "";
      input.style.borderColor = "#10b981";
      setTimeout(() => input.style.borderColor = "", 1000);
    } else {
      alert("Please write your feedback!");
    }
  }

  // =====================================================================
  // KEYBOARD SHORTCUTS
  // =====================================================================
  document.addEventListener('keydown', function(event) {
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

    if (event.code === 'Space') {
      event.preventDefault();
      startSpeech();
    }
    if (event.code === 'Escape') stopSpeaking();
    if (event.code === 'KeyR' && !event.ctrlKey) replaySpeech();
    if (event.code === 'KeyP' && !event.ctrlKey) {
      if (window.speechSynthesis.paused) resumeSpeaking();
      else if (window.speechSynthesis.speaking) pauseSpeaking();
    }
  });

  // =====================================================================
  // INITIALIZATION
  // =====================================================================
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => {
      console.log(`ğŸ”Š ${window.speechSynthesis.getVoices().length} voices loaded`);
    };
  }

  console.log('ğŸ™ï¸ Yalla Habibi initialized');
  console.log('âŒ¨ï¸ Shortcuts: SPACE=Listen | ESC=Stop | R=Replay | P=Pause/Resume');
  console.log('ğŸ¤– Auto Mode: Speak naturally in your language!');
</script>

{% endblock %}