{% extends "base.html" %}

{% block title %}Yalla Habibi | Multilingual Voice Assistant{% endblock %}
{% block og_title %}Yalla Habibi â€“ Multilingual Voice Assistant{% endblock %}
{% block og_description %}Speak naturally. Get intelligent multilingual responses in 40+ languages.{% endblock %}

{% block content %}

<div class="glass-card">
  <header>
    <h1>Yalla <span>Habibi</span></h1>
    <p id="hook">"I am your Native Arabic host. How can I bridge your world today?"</p>

    <div class="pref-container">
      <label for="pref-lang">ğŸŒ Select Your Language:</label>
      <select id="pref-lang" aria-label="Select your preferred language">
        <!-- Most Popular Languages (Top of List) -->
        <option value="en-US" selected>ğŸŒ English</option>
        <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
        <option value="bn-BD">ğŸ‡§ğŸ‡© Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
        <option value="hi-IN">ğŸ‡®ğŸ‡³ Hindi (à¤¹à¤¿à¤‚à¤¦à¥€)</option>
        <option value="es-ES">ğŸ‡ªğŸ‡¸ Spanish (EspaÃ±ol)</option>
        <option value="fr-FR">ğŸ‡«ğŸ‡· French (FranÃ§ais)</option>
        <option value="de-DE">ğŸ‡©ğŸ‡ª German (Deutsch)</option>
        
        <!-- Additional Major Languages -->
        <option value="pt-BR">ğŸ‡§ğŸ‡· Portuguese (PortuguÃªs)</option>
        <option value="ru-RU">ğŸ‡·ğŸ‡º Russian (Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
        <option value="ja-JP">ğŸ‡¯ğŸ‡µ Japanese (æ—¥æœ¬èª)</option>
        <option value="ko-KR">ğŸ‡°ğŸ‡· Korean (í•œêµ­ì–´)</option>
        <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese (ä¸­æ–‡)</option>
        <option value="it-IT">ğŸ‡®ğŸ‡¹ Italian (Italiano)</option>
        <option value="tr-TR">ğŸ‡¹ğŸ‡· Turkish (TÃ¼rkÃ§e)</option>
        
        <!-- Middle Eastern Languages -->
        <option value="ur-PK">ğŸ‡µğŸ‡° Urdu (Ø§Ø±Ø¯Ùˆ)</option>
        <option value="fa-IR">ğŸ‡®ğŸ‡· Persian (ÙØ§Ø±Ø³ÛŒ)</option>
        <option value="he-IL">ğŸ‡®ğŸ‡± Hebrew (×¢×‘×¨×™×ª)</option>
        
        <!-- South Asian Languages -->
        <option value="ta-IN">ğŸ‡®ğŸ‡³ Tamil (à®¤à®®à®¿à®´à¯)</option>
        <option value="te-IN">ğŸ‡®ğŸ‡³ Telugu (à°¤à±†à°²à±à°—à±)</option>
        <option value="ml-IN">ğŸ‡®ğŸ‡³ Malayalam (à´®à´²à´¯à´¾à´³à´‚)</option>
        <option value="mr-IN">ğŸ‡®ğŸ‡³ Marathi (à¤®à¤°à¤¾à¤ à¥€)</option>
        <option value="gu-IN">ğŸ‡®ğŸ‡³ Gujarati (àª—à«àªœàª°àª¾àª¤à«€)</option>
        <option value="kn-IN">ğŸ‡®ğŸ‡³ Kannada (à²•à²¨à³à²¨à²¡)</option>
        <option value="pa-IN">ğŸ‡®ğŸ‡³ Punjabi (à¨ªà©°à¨œà¨¾à¨¬à©€)</option>
        
        <!-- Southeast Asian Languages -->
        <option value="id-ID">ğŸ‡®ğŸ‡© Indonesian (Bahasa Indonesia)</option>
        <option value="ms-MY">ğŸ‡²ğŸ‡¾ Malay (Bahasa Melayu)</option>
        <option value="th-TH">ğŸ‡¹ğŸ‡­ Thai (à¹„à¸—à¸¢)</option>
        <option value="vi-VN">ğŸ‡»ğŸ‡³ Vietnamese (Tiáº¿ng Viá»‡t)</option>
        
        <!-- European Languages -->
        <option value="nl-NL">ğŸ‡³ğŸ‡± Dutch (Nederlands)</option>
        <option value="pl-PL">ğŸ‡µğŸ‡± Polish (Polski)</option>
        <option value="sv-SE">ğŸ‡¸ğŸ‡ª Swedish (Svenska)</option>
        <option value="no-NO">ğŸ‡³ğŸ‡´ Norwegian (Norsk)</option>
        <option value="da-DK">ğŸ‡©ğŸ‡° Danish (Dansk)</option>
        <option value="fi-FI">ğŸ‡«ğŸ‡® Finnish (Suomi)</option>
        <option value="el-GR">ğŸ‡¬ğŸ‡· Greek (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)</option>
        <option value="cs-CZ">ğŸ‡¨ğŸ‡¿ Czech (ÄŒeÅ¡tina)</option>
        <option value="hu-HU">ğŸ‡­ğŸ‡º Hungarian (Magyar)</option>
        <option value="ro-RO">ğŸ‡·ğŸ‡´ Romanian (RomÃ¢nÄƒ)</option>
        <option value="uk-UA">ğŸ‡ºğŸ‡¦ Ukrainian (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)</option>
        
        <!-- African Languages -->
        <option value="sw-KE">ğŸ‡°ğŸ‡ª Swahili (Kiswahili)</option>
        <option value="am-ET">ğŸ‡ªğŸ‡¹ Amharic (áŠ áˆ›áˆ­áŠ›)</option>
      </select>
    </div>

    <div class="secondary-links">
      <a href="/manual" title="Learn how to use Yalla Habibi">ğŸ“˜ User Manual</a>
      <span class="divider">|</span>
      <a href="/api/languages" title="View all supported languages">ğŸŒ All Languages</a>
    </div>
  </header>

  <!-- DEMOGRAPHIC HINT SYMBOLS -->
  <div class="benefit-hints">
    <span>ğŸ‘·â€â™‚ï¸ Translation for Work</span> â€¢ 
    <span>ğŸ“ Moral Lessons</span> â€¢ 
    <span>ğŸŒ Eco Tips</span> â€¢ 
    <span>ğŸ—ºï¸ Location Help</span>
  </div>

  <!-- ===== VOICE CONTROLS SECTION ===== -->
  <div class="voice-controls">
    <h3>ğŸšï¸ Voice Controls</h3>
    <div class="voice-hint" id="voice-setup-hint">
      ğŸ’¡ <strong>Voice Setup:</strong> To hear responses in your language, enable your language voice in device settings. 
      <a href="/manual#voice-setup" target="_blank">Need help?</a>
    </div>

    <div class="control-group">
      <label for="volume-slider">
        ğŸ”Š Volume
        <span id="volume-value">100%</span>
      </label>
      <input 
        type="range" 
        min="0" 
        max="100" 
        value="100" 
        class="slider" 
        id="volume-slider"
        aria-label="Adjust volume"
      >
    </div>

    <div class="control-group">
      <label for="speed-slider">
        âš¡ Speed
        <span id="speed-value">Normal</span>
      </label>
      <input 
        type="range" 
        min="50" 
        max="200" 
        value="95" 
        class="slider" 
        id="speed-slider"
        aria-label="Adjust speaking speed"
      >
    </div>

    <div class="voice-action-buttons">
      <button 
        class="voice-btn stop" 
        id="stop-btn" 
        onclick="stopSpeaking()" 
        disabled
        aria-label="Stop speaking"
      >
        â¹ï¸ Stop
      </button>

      <button 
        class="voice-btn replay" 
        id="replay-btn" 
        onclick="replaySpeech()" 
        disabled
        aria-label="Replay last response"
      >
        ğŸ” Replay
      </button>
    </div>

    <!-- Pause/Resume Controls -->
    <div class="voice-action-buttons">
      <button 
        class="voice-btn pause" 
        id="pause-btn" 
        onclick="pauseSpeaking()" 
        disabled
        aria-label="Pause speaking"
      >
        â¸ï¸ Pause
      </button>

      <button 
        class="voice-btn resume" 
        id="resume-btn" 
        onclick="resumeSpeaking()" 
        disabled
        aria-label="Resume speaking"
      >
        â–¶ï¸ Resume
      </button>
    </div>

    <div class="speaking-indicator" id="speaking-indicator">
      <span>ğŸ”Š Speaking...</span>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
  </div>

  <!-- MAIN INTERACTION AREA -->
  <div class="main-body">
    <div id="status" role="status" aria-live="polite">
      {% if active_lang == "bn" %}
        à¦¹à¦¾à¦¬à¦¿à¦¬à¦¿à¦° à¦¸à¦¾à¦¥à§‡ à¦•à¦¥à¦¾ à¦¬à¦²à¦¤à§‡ à¦®à¦¾à¦‡à¦• à¦šà¦¾à¦ªà§à¦¨...
      {% elif active_lang == "ar" %}
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø­Ø¨ÙŠØ¨ÙŠ...
      {% elif active_lang == "hi" %}
        à¤¹à¤¬à¥€à¤¬à¥€ à¤¸à¥‡ à¤¬à¤¾à¤¤ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤®à¤¾à¤‡à¤• à¤¦à¤¬à¤¾à¤à¤‚...
      {% elif active_lang == "ur" %}
        Ø­Ø¨ÛŒØ¨ÛŒ Ø³Û’ Ø¨Ø§Øª Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ù…Ø§Ø¦ÛŒÚ© Ø¯Ø¨Ø§Ø¦ÛŒÚº...
      {% elif active_lang == "es" %}
        Presiona el micrÃ³fono para hablar con Habibi...
      {% elif active_lang == "fr" %}
        Appuyez sur le micro pour parler avec Habibi...
      {% elif active_lang == "de" %}
        DrÃ¼cken Sie das Mikrofon, um mit Habibi zu sprechen...
      {% else %}
        Press the microphone to speak with Habibi...
      {% endif %}
    </div>

    <!-- Microphone Button -->
    <button 
      id="mic-btn" 
      type="button"
      aria-label="Press to start speaking"
      title="Press and speak (or press SPACE)"
    >
      <div class="pulse" id="pulse"></div>
      <span>ğŸ™ï¸</span>
    </button>

    <div id="user-transcript" aria-live="polite">...</div>

    <!-- AI Response Box -->
    <div class="ai-box">
      <div id="response-text">
        Marhaba! ğŸ‘‹ I assist foreigners across the Peninsula in 40+ languages.
      </div>
      
      <p class="voice-hint">
        <strong>Try asking:</strong><br>
        "Translate Arabic to Bengali" â€¢ "Find mosque near me" â€¢ "Explain visa rules" â€¢ 
        "What's the weather?" â€¢ "Direction to hospital"
      </p>

      <!-- Map Container -->
      <div id="map-wrap" class="hidden">
        <iframe 
          id="google-map" 
          width="100%" 
          height="200" 
          src=""
          title="Location map"
          loading="lazy"
        ></iframe>
      </div>

      <!-- Wisdom Box -->
      <div id="wisdom-box" class="hidden">
        <p id="wisdom-text"></p>
      </div>
    </div>
  </div>

  <!-- ===== SOCIAL SHARE SECTION ===== -->
  <div class="social-share-section">
    <div class="share-gpt">
      âœ¨ <strong>Try on ChatGPT:</strong>
      <a 
        href="https://chatgpt.com/g/g-698b641c04208191bb1c0f8861bac508-yalla-habibi-multilingual-voice-translation" 
        target="_blank"
        rel="noopener noreferrer"
      >
        Yalla Habibi GPT Experience
      </a>
    </div>

    <h3>ğŸš€ Share Yalla Habibi</h3>
    <p class="share-subtitle">Help others discover this multilingual AI assistant!</p>

    <div class="share-buttons">
      <button class="share-btn facebook" onclick="shareOnFacebook()" aria-label="Share on Facebook">
        <span>ğŸ“˜ Facebook</span>
      </button>
      <button class="share-btn twitter" onclick="shareOnTwitter()" aria-label="Share on Twitter">
        <span>ğ• Twitter</span>
      </button>
      <button class="share-btn linkedin" onclick="shareOnLinkedIn()" aria-label="Share on LinkedIn">
        <span>ğŸ’¼ LinkedIn</span>
      </button>
      <button class="share-btn whatsapp" onclick="shareOnWhatsApp()" aria-label="Share on WhatsApp">
        <span>ğŸ’¬ WhatsApp</span>
      </button>
      <button class="share-btn telegram" onclick="shareOnTelegram()" aria-label="Share on Telegram">
        <span>âœˆï¸ Telegram</span>
      </button>
      <button class="share-btn reddit" onclick="shareOnReddit()" aria-label="Share on Reddit">
        <span>ğŸ¤– Reddit</span>
      </button>
    </div>

    <div class="copy-link-section">
      <input 
        type="text" 
        class="copy-link-input" 
        id="share-url" 
        readonly 
        value="https://yallahabibi.seosiri.com"
        aria-label="Share URL"
      >
      <button 
        class="copy-link-btn" 
        id="copy-btn" 
        onclick="copyShareLink()"
        aria-label="Copy link to clipboard"
      >
        ğŸ“‹ Copy Link
      </button>
    </div>

    <div class="share-stats">
      Thank you for sharing! Every share helps grow our global community ğŸ’š
    </div>
  </div>

  <!-- COMMUNITY TICKER -->
  <div class="community-ticker">
    <div class="ticker-content" id="ticker">
      "Worlds are waiting to listen to you..." - Share your feedback and join our multilingual community!
    </div>
  </div>

  <!-- FEEDBACK BOX -->
  <div class="feedback-box">
    <input 
      type="text" 
      id="feedback-in" 
      placeholder="Loved Yalla Habibi? Share your experience..."
      aria-label="Feedback input"
      maxlength="200"
    >
    <button onclick="postFeedback()" aria-label="Post feedback">Post</button>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-content">
      <span class="made-in-badge">ğŸ‡§ğŸ‡© Made in Bangladesh</span>
      <span class="footer-divider">â€¢</span>
      <span>Created by <a href="https://www.seosiri.com/p/about.html" target="_blank" rel="noopener">Momenul Ahmad</a></span>
      <span class="footer-divider">â€¢</span>
      <span><a href="https://www.seosiri.com" target="_blank" rel="noopener">SEOSiri</a></span>
      <span class="footer-divider">â€¢</span>
      <span>40+ Languages Supported</span>
    </div>
  </footer>
</div>

<script>
  // =====================================================================
  // STATE MANAGEMENT
  // =====================================================================
  let currentUtterance = null;
  let lastResponseText = "";
  let lastResponseLang = "en-US";
  let isSpeaking = false;
  let isPaused = false;

  // Voice control values
  let speechVolume = 1.0;
  let speechRate = 1.0;

  // Recognition control
  let recognitionActive = false;

  // =====================================================================
  // SHARE CONFIGURATION
  // =====================================================================
  const SHARE_CONFIG = {
    url: window.location.origin || "https://yallahabibi.seosiri.com",
    title: "Yalla Habibi â€“ Multilingual Voice Assistant",
    description: "Speak naturally with AI in 40+ languages"
  };

  // Initialize share URL input
  const shareInput = document.getElementById('share-url');
  if (shareInput) shareInput.value = SHARE_CONFIG.url;

  // Share Functions
  function shareOnFacebook() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_CONFIG.url)}`;
    window.open(url, 'fb-share', 'width=600,height=400');
  }

  function shareOnTwitter() {
    const text = encodeURIComponent(`ğŸ™ï¸ ${SHARE_CONFIG.title}\n${SHARE_CONFIG.description}\n${SHARE_CONFIG.url}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`, 'twitter-share', 'width=600,height=400');
  }

  function shareOnLinkedIn() {
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_CONFIG.url)}`, 'linkedin-share', 'width=600,height=400');
  }

  function shareOnWhatsApp() {
    const text = encodeURIComponent(`${SHARE_CONFIG.title}\n${SHARE_CONFIG.url}`);
    window.open(`https://wa.me/?text=${text}`, 'whatsapp-share');
  }

  function shareOnTelegram() {
    const text = encodeURIComponent(SHARE_CONFIG.title);
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_CONFIG.url)}&text=${text}`, 'telegram-share');
  }

  function shareOnReddit() {
    window.open(`https://reddit.com/submit?url=${encodeURIComponent(SHARE_CONFIG.url)}&title=${encodeURIComponent(SHARE_CONFIG.title)}`, 'reddit-share', 'width=800,height=600');
  }

  function copyShareLink() {
    const input = document.getElementById('share-url');
    input.select();
    input.setSelectionRange(0, 99999); // Mobile support
    
    navigator.clipboard.writeText(SHARE_CONFIG.url).then(() => {
      const btn = document.getElementById("copy-btn");
      const originalText = btn.innerHTML;
      btn.innerHTML = "âœ… Copied!";
      btn.style.background = "#10b981";
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = "";
      }, 2000);
    }).catch(err => {
      console.error('Copy failed:', err);
      alert('Link copied: ' + SHARE_CONFIG.url);
    });
  }

  // =====================================================================
  // SPEECH RECOGNITION SETUP
  // =====================================================================
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRec ? new SpeechRec() : null;

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
  }

  // Enhanced language mapping for recognition
  const PREF_TO_RECO_LANG = {
    "bn-BD": "bn-BD", "hi-IN": "hi-IN", "es-ES": "es-ES", "pt-BR": "pt-BR",
    "fr-FR": "fr-FR", "de-DE": "de-DE", "it-IT": "it-IT", "ru-RU": "ru-RU",
    "ja-JP": "ja-JP", "ko-KR": "ko-KR", "zh-CN": "zh-CN", "tr-TR": "tr-TR",
    "ar-SA": "ar-SA", "en-US": "en-US", "ur-PK": "ur-PK", "fa-IR": "fa-IR",
    "id-ID": "id-ID", "ms-MY": "ms-MY", "th-TH": "th-TH", "vi-VN": "vi-VN",
    "nl-NL": "nl-NL", "pl-PL": "pl-PL", "sv-SE": "sv-SE", "no-NO": "no-NO",
    "da-DK": "da-DK", "fi-FI": "fi-FI", "el-GR": "el-GR", "he-IL": "he-IL",
    "cs-CZ": "cs-CZ", "hu-HU": "hu-HU", "ro-RO": "ro-RO", "uk-UA": "uk-UA",
    "sw-KE": "sw-KE", "am-ET": "am-ET", "ta-IN": "ta-IN", "te-IN": "te-IN",
    "ml-IN": "ml-IN", "mr-IN": "mr-IN", "gu-IN": "gu-IN", "kn-IN": "kn-IN",
    "pa-IN": "pa-IN"
  };

  function pickRecognitionLang() {
    const pref = document.getElementById('pref-lang').value;
    return PREF_TO_RECO_LANG[pref] || "en-US";
  }

  // Auto-detect and map language codes
  function mapDetectedToPref(det) {
    if (!det) return null;
    const d = det.toLowerCase();
    
    const langMap = {
      "bn": "bn-BD", "hi": "hi-IN", "es": "es-ES", "pt": "pt-BR",
      "fr": "fr-FR", "de": "de-DE", "it": "it-IT", "ru": "ru-RU",
      "ja": "ja-JP", "ko": "ko-KR", "zh": "zh-CN", "tr": "tr-TR",
      "ar": "ar-SA", "en": "en-US", "ur": "ur-PK", "fa": "fa-IR",
      "id": "id-ID", "ms": "ms-MY", "th": "th-TH", "vi": "vi-VN",
      "nl": "nl-NL", "pl": "pl-PL", "sv": "sv-SE", "no": "no-NO",
      "da": "da-DK", "fi": "fi-FI", "el": "el-GR", "he": "he-IL",
      "cs": "cs-CZ", "hu": "hu-HU", "ro": "ro-RO", "uk": "uk-UA",
      "sw": "sw-KE", "am": "am-ET", "ta": "ta-IN", "te": "te-IN",
      "ml": "ml-IN", "mr": "mr-IN", "gu": "gu-IN", "kn": "kn-IN",
      "pa": "pa-IN"
    };
    
    for (const [prefix, code] of Object.entries(langMap)) {
      if (d.startsWith(prefix)) return code;
    }
    return null;
  }

  // =====================================================================
  // VOICE CONTROLS (Perceptual Mapping)
  // =====================================================================
  const volumeSlider = document.getElementById('volume-slider');
  const speedSlider = document.getElementById('speed-slider');
  const volumeValue = document.getElementById('volume-value');
  const speedValue = document.getElementById('speed-value');

  // Perceptual volume curve
  function mapVolume(sliderVal) {
    const x = Math.max(0, Math.min(100, sliderVal)) / 100;
    return Math.pow(x, 1.8);
  }

  // Natural rate mapping
  function mapRate(sliderVal) {
    const v = Math.max(50, Math.min(200, sliderVal));
    const t = (v - 50) / 150;
    const eased = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2)/2;
    return 0.75 + eased * 0.75;
  }

  function updateSpeedLabel(raw) {
    const v = Number(raw);
    const label = v < 80 ? "Slow" : v < 115 ? "Normal" : "Fast";
    speedValue.textContent = label;
  }

  function updateVolumeLabel(raw) {
    volumeValue.textContent = `${raw}%`;
  }

  // Initialize
  speechVolume = mapVolume(Number(volumeSlider.value));
  speechRate = mapRate(Number(speedSlider.value));
  updateVolumeLabel(volumeSlider.value);
  updateSpeedLabel(speedSlider.value);

  volumeSlider.addEventListener('input', function() {
    speechVolume = mapVolume(Number(this.value));
    updateVolumeLabel(this.value);
    if (currentUtterance && isSpeaking) {
      currentUtterance.volume = speechVolume;
    }
  });

  speedSlider.addEventListener('input', function() {
    speechRate = mapRate(Number(this.value));
    updateSpeedLabel(this.value);
    if (currentUtterance && isSpeaking) {
      currentUtterance.rate = speechRate;
    }
  });

  // =====================================================================
  // UI HELPERS
  // =====================================================================
  function resetUI(message = "Press the microphone to speak...") {
    document.getElementById('pulse').style.display = 'none';
    document.getElementById('status').innerText = message;
    document.getElementById('mic-btn').classList.remove('recording');
  }

  function setSpeakingUI(active) {
    const stopBtn = document.getElementById('stop-btn');
    const replayBtn = document.getElementById('replay-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const indicator = document.getElementById('speaking-indicator');

    if (active) {
      stopBtn.disabled = false;
      replayBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      indicator.classList.add('active');
    } else {
      stopBtn.disabled = true;
      replayBtn.disabled = !lastResponseText;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      indicator.classList.remove('active');
    }
  }

  function setPausedUI(paused) {
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    
    if (paused) {
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    } else {
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
    }
  }

  // =====================================================================
  // MICROPHONE BUTTON (Mobile-Optimized)
  // =====================================================================
  const micBtn = document.getElementById('mic-btn');

  micBtn.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    startSpeech();
  }, { passive: false });

  // =====================================================================
  // RECOGNITION HANDLERS
  // =====================================================================
  if (recognition) {
    recognition.onstart = () => {
      recognitionActive = true;
      document.getElementById('pulse').style.display = 'block';
      document.getElementById('status').innerText = "ğŸ¤ Listening...";
      document.getElementById('mic-btn').classList.add('recording');
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      recognitionActive = false;
      
      const errorMessages = {
        'no-speech': 'No speech detected. Please try again.',
        'audio-capture': 'Microphone access error. Please check permissions.',
        'not-allowed': 'Microphone permission denied.',
        'network': 'Network error. Please check your connection.'
      };
      
      resetUI(errorMessages[event.error] || `Error: ${event.error}. Try again!`);
    };

    recognition.onend = () => {
      recognitionActive = false;
      if (document.getElementById('status').innerText === "ğŸ¤ Listening...") {
        resetUI("No speech detected. Please try again!");
      }
    };

    recognition.onresult = (event) => {
      const result = event.results[0][0];
      const text = result.transcript || "";
      const detectedLang = (result.lang || event.results[0].lang || recognition.lang || "").trim();

      // Auto-switch language
      const mapped = mapDetectedToPref(detectedLang);
      if (mapped) {
        const prefEl = document.getElementById('pref-lang');
        if (prefEl && prefEl.value !== mapped) {
          prefEl.value = mapped;
          console.log('ğŸŒ Auto-switched to:', mapped);
        }
      }

      const pref = document.getElementById('pref-lang').value;

      document.getElementById('user-transcript').innerText = `"${text}"`;
      document.getElementById('status').innerText = "âš™ï¸ Processing...";
      document.getElementById('pulse').style.display = 'none';

      // API Call
      fetch(`/api/chat?user_input=${encodeURIComponent(text)}&pref=${encodeURIComponent(pref)}`)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(data => {
          resetUI("âœ… Response received! Speak again...");

          const parts = (data.reply || "").split('--- Wisdom:');
          document.getElementById('response-text').innerText = parts[0] || "";

          // Wisdom Box
          if (parts[1]) {
            document.getElementById('wisdom-box').classList.remove('hidden');
            document.getElementById('wisdom-text').innerText = "ğŸŒ± " + parts[1].trim();
          } else {
            document.getElementById('wisdom-box').classList.add('hidden');
          }

          // Map Integration
          if (data.map_link) {
            document.getElementById('map-wrap').classList.remove('hidden');
            document.getElementById('google-map').src = data.map_link;
          } else {
            document.getElementById('map-wrap').classList.add('hidden');
          }

          lastResponseText = data.reply || "";
          lastResponseLang = data.voice_lang || pref;

          speak(lastResponseText, lastResponseLang);
        })
        .catch(error => {
          console.error('API error:', error);
          resetUI("âŒ Connection error. Try again!");
          document.getElementById('response-text').innerText = "Habibi encountered an error. Please try again or check your internet connection.";
        });
    };
  }

  function startSpeech() {
    if (!recognition) {
      alert("âš ï¸ Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.");
      return;
    }

    // Stop TTS if speaking
    if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
      window.speechSynthesis.cancel();
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
    }

    if (recognitionActive) return;

    try {
      recognition.lang = pickRecognitionLang();
      recognition.start();
    } catch (e) {
      console.error('Recognition start error:', e);
      resetUI("Microphone in use. Please try again.");
    }
  }

  // =====================================================================
  // TEXT-TO-SPEECH WITH VOICE SELECTION
  // =====================================================================
  function speak(text, lang) {
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.volume = speechVolume;
    utterance.rate = speechRate;

    const voices = window.speechSynthesis.getVoices();

    // Voice selection logic
    let selectedVoice = voices.find(v => v.lang === lang);

    if (!selectedVoice) {
      const prefix = lang.split('-')[0];
      selectedVoice = voices.find(v => v.lang.startsWith(prefix));
    }

    if (selectedVoice) {
      utterance.voice = selectedVoice;
      console.log("âœ… Voice selected:", selectedVoice.name, selectedVoice.lang);
      document.getElementById('voice-setup-hint').style.display = 'none';
    } else {
      console.warn("âš ï¸ No native voice for:", lang, "â†’ Using default");
      document.getElementById('voice-setup-hint').style.display = 'block';
    }

    currentUtterance = utterance;
    isSpeaking = true;
    setSpeakingUI(true);

    utterance.onend = () => {
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
      console.log('âœ… Speech ended');
    };

    utterance.onerror = (e) => {
      console.error('Speech error:', e);
      isSpeaking = false;
      setSpeakingUI(false);
    };

    window.speechSynthesis.speak(utterance);
  }

  function pauseSpeaking() {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
      window.speechSynthesis.pause();
      isPaused = true;
      setPausedUI(true);
      console.log("â¸ï¸ Paused");
    }
  }

  function resumeSpeaking() {
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
      isPaused = false;
      setPausedUI(false);
      console.log("â–¶ï¸ Resumed");
    }
  }

  function stopSpeaking() {
    window.speechSynthesis.cancel();
    isSpeaking = false;
    isPaused = false;
    setSpeakingUI(false);
    setPausedUI(false);
    console.log('ğŸ›‘ Speech stopped');
  }

  function replaySpeech() {
    if (lastResponseText) {
      console.log('ğŸ” Replaying last response');
      speak(lastResponseText, lastResponseLang);
    }
  }

  // =====================================================================
  // FEEDBACK SYSTEM
  // =====================================================================
  function postFeedback() {
    const input = document.getElementById('feedback-in');
    const val = input.value.trim();
    
    if (val) {
      const ticker = document.getElementById('ticker');
      ticker.innerText = `"${val}" - ${ticker.innerText}`;
      input.value = "";
      
      // Visual feedback
      input.style.borderColor = "#10b981";
      setTimeout(() => {
        input.style.borderColor = "";
      }, 1000);
      
      console.log('ğŸ’¬ Feedback posted:', val);
    } else {
      alert("Please write your feedback before posting!");
    }
  }

  // =====================================================================
  // KEYBOARD SHORTCUTS
  // =====================================================================
  document.addEventListener('keydown', function(event) {
    // Ignore if typing in input
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
      return;
    }

    // SPACE = Start listening
    if (event.code === 'Space') {
      event.preventDefault();
      startSpeech();
    }

    // ESC = Stop speaking
    if (event.code === 'Escape') {
      stopSpeaking();
    }

    // R = Replay
    if (event.code === 'KeyR' && !event.ctrlKey) {
      replaySpeech();
    }

    // P = Pause/Resume
    if (event.code === 'KeyP' && !event.ctrlKey) {
      if (window.speechSynthesis.paused) {
        resumeSpeaking();
      } else if (window.speechSynthesis.speaking) {
        pauseSpeaking();
      }
    }
  });

  // =====================================================================
  // INITIALIZATION
  // =====================================================================
  // Load voices when available
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => {
      const voices = window.speechSynthesis.getVoices();
      console.log(`ğŸ”Š ${voices.length} voices loaded`);
    };
  }

  // Console info
  console.log('ğŸ™ï¸ Yalla Habibi initialized');
  console.log('âŒ¨ï¸ Shortcuts: SPACE=Listen | ESC=Stop | R=Replay | P=Pause/Resume');
  console.log('ğŸŒ Share URL:', SHARE_CONFIG.url);
  console.log('ğŸ—£ï¸ Supported languages: 40+');
</script>

{% endblock %}