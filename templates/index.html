{% extends "base.html" %}

{% block title %}Yalla Habibi{% endblock %}
{% block og_title %}Yalla Habibi â€“ Multilingual Voice Assistant{% endblock %}
{% block og_description %}Speak naturally. Get intelligent multilingual responses.{% endblock %}

{% block content %}


<div class="glass-card">
  <header>
    <h1>Yalla <span>Habibi</span></h1>
    <p id="hook">"I am your Native Arabic host. How can I bridge your world today?"</p>

    <div class="pref-container">
      <label>Select Your Tongue:</label>
      <select id="pref-lang">
        <option value="bn-BD">ğŸ‡§ğŸ‡© Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)</option>
        <option value="hi-IN">ğŸ‡®ğŸ‡³ Hindi</option>
        <option value="es-ES">ğŸ‡ªğŸ‡¸ Spanish</option>
        <option value="pt-BR">ğŸ‡§ğŸ‡· Portuguese</option>
        <option value="fr-FR">ğŸ‡«ğŸ‡· French</option>
        <option value="de-DE">ğŸ‡©ğŸ‡ª German</option>
        <option value="it-IT">ğŸ‡®ğŸ‡¹ Italian</option>
        <option value="ru-RU">ğŸ‡·ğŸ‡º Russian</option>
        <option value="ja-JP">ğŸ‡¯ğŸ‡µ Japanese</option>
        <option value="ko-KR">ğŸ‡°ğŸ‡· Korean</option>
        <option value="zh-CN">ğŸ‡¨ğŸ‡³ Chinese</option>
        <option value="tr-TR">ğŸ‡¹ğŸ‡· Turkish</option>
        <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Arabic</option>
        <option value="en-US" selected>ğŸŒ English</option>
      </select>
    </div>

    <div class="secondary-links">
      <a href="/manual">ğŸ“˜ User Manual</a>
    </div>
  </header>

  <!-- DEMOGRAPHIC HINT SYMBOLS -->
  <div class="benefit-hints">
    <span>ğŸ‘·â€â™‚ï¸ Translation for Work</span> â€¢ <span>ğŸ“ Moral Lessons</span> â€¢ <span>ğŸŒ Eco Tips</span>
  </div>

  <!-- ===== VOICE CONTROLS SECTION ===== -->
  <div class="voice-controls">
    <h3>ğŸšï¸ Voice Controls</h3>
    <div class="voice-hint">
        To hear responses in your language, please enable your language voice in your device settings. Need help? Iâ€™ll gladly guide you.
    </div>

    <div class="control-group">
      <label>
        ğŸ”Š Volume
        <span id="volume-value">100%</span>
      </label>
      <input type="range" min="0" max="100" value="100" class="slider" id="volume-slider">
    </div>

    <div class="control-group">
      <label>
        âš¡ Speed
        <span id="speed-value">Normal</span>
      </label>
      <input type="range" min="50" max="200" value="95" class="slider" id="speed-slider">
    </div>

    <div class="voice-action-buttons">
      <button class="voice-btn stop" id="stop-btn" onclick="stopSpeaking()" disabled>
        â¹ï¸ Stop Speaking
      </button>

      <button class="voice-btn replay" id="replay-btn" onclick="replaySpeech()" disabled>
        ğŸ” Replay Last
      </button>
    </div>

    <!-- NEW: Pause/Resume -->
    <div class="voice-action-buttons">
      <button class="voice-btn pause" id="pause-btn" onclick="pauseSpeaking()" disabled>
        â¸ï¸ Pause
      </button>

      <button class="voice-btn resume" id="resume-btn" onclick="resumeSpeaking()" disabled>
        â–¶ï¸ Resume
      </button>
    </div>

    <div class="speaking-indicator" id="speaking-indicator">
      <span>Speaking:</span>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
  </div>

  <div class="main-body">
    <div id="status">Speak to Habibi...</div>
<div id="status">
{% if active_lang == "bn" %}
à¦¹à¦¾à¦¬à¦¿à¦¬à¦¿à¦° à¦¸à¦¾à¦¥à§‡ à¦•à¦¥à¦¾ à¦¬à¦²à¦¤à§‡ à¦®à¦¾à¦‡à¦• à¦šà¦¾à¦ªà§à¦¨...
{% elif active_lang == "ar" %}
Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„ØªØ­Ø¯Ø«...
{% else %}
Speak to Habibi...
{% endif %}
</div>

    <!-- Better mobile interaction: pointerdown -->
    <button id="mic-btn" type="button">
      <div class="pulse" id="pulse"></div>
      <span>ğŸ™ï¸</span>
    </button>

    <div id="user-transcript">...</div>

    <div class="ai-box">
      <div id="response-text">Marhaba! I assist foreigners across the Peninsula.</div>
      <p class="voice-hint">
Speak naturally. Ask things like:<br>
â€œTranslate Arabic to Bengaliâ€ â€¢ â€œFind mosque near meâ€ â€¢ â€œExplain visa rulesâ€
</p>

      <div id="map-wrap" class="hidden">
        <iframe id="google-map" width="100%" height="200" src=""></iframe>
      </div>
      <div id="wisdom-box" class="hidden"><p id="wisdom-text"></p></div>
    </div>
  </div>

  <!-- ===== SOCIAL SHARE SECTION ===== -->
  <div class="social-share-section">
    <div class="share-gpt">
      âœ¨ Explore Habibi on GPT:
      <a href="https://chatgpt.com/g/g-698b641c04208191bb1c0f8861bac508-yalla-habibi-multilingual-voice-translation" target="_blank">
        Yalla Habibi GPT Experience
      </a>
    </div>

    <h3>ğŸš€ Share Yalla Habibi</h3>
    <p class="share-subtitle">Help others discover this multilingual AI assistant!</p>

    <div class="share-buttons">
      <a href="#" class="share-btn facebook" onclick="shareOnFacebook(); return false;">
        <span>ğŸ“˜ Facebook</span>
      </a>
      <a href="#" class="share-btn twitter" onclick="shareOnTwitter(); return false;">
        <span>ğ• Twitter</span>
      </a>
      <a href="#" class="share-btn linkedin" onclick="shareOnLinkedIn(); return false;">
        <span>ğŸ’¼ LinkedIn</span>
      </a>
      <a href="#" class="share-btn whatsapp" onclick="shareOnWhatsApp(); return false;">
        <span>ğŸ’¬ WhatsApp</span>
      </a>
      <a href="#" class="share-btn telegram" onclick="shareOnTelegram(); return false;">
        <span>âœˆï¸ Telegram</span>
      </a>
      <a href="#" class="share-btn reddit" onclick="shareOnReddit(); return false;">
        <span>ğŸ¤– Reddit</span>
      </a>
    </div>

    <div class="copy-link-section">
      <input type="text" class="copy-link-input" id="share-url" readonly value="https://www.seosiri.com">
      <button class="copy-link-btn" id="copy-btn" onclick="copyShareLink()">
        ğŸ“‹ Copy Link
      </button>
    </div>

    <div class="share-stats">
      Thank you for sharing! Every share helps grow our community ğŸ’š
    </div>
  </div>

  <div class="community-ticker">
    <div class="ticker-content" id="ticker">"Worlds are waiting to listen to you..." - Share your feedback!</div>
  </div>

  <div class="feedback-box">
    <input type="text" id="feedback-in" placeholder="Loved Yalla Habibi? Share...">
    <button onclick="postFeedback()">Post</button>
  </div>

  <footer>
    Created by <a href="https://www.seosiri.com/p/about.html" target="_blank">Momenul Ahmad</a> | SEOSiri
  </footer>
</div>

<script>
  // =====================================================================
  // STATE
  // =====================================================================
  let currentUtterance = null;
  let lastResponseText = "";
  let lastResponseLang = "en-US";
  let isSpeaking = false;
  let isPaused = false;

  // slider values -> mapped (not linear)
  let speechVolume = 1.0;  // 0..1 (perceived curve)
  let speechRate = 1.0;    // natural mapping

  // recognition control
  let recognitionActive = false;

  // =====================================================================
  // SHARE (domain-safe)
  // =====================================================================
  const SHARE_CONFIG = {
    url: window.location.origin,
    title: "Yalla Habibi â€“ Multilingual Voice Assistant"
  };

  // ensure input shows correct URL
  const shareInput = document.getElementById('share-url');
  if (shareInput) shareInput.value = SHARE_CONFIG.url;

  function shareOnFacebook() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SHARE_CONFIG.url)}`;
    window.open(url, 'fb', 'width=600,height=400');
  }
  function shareOnTwitter() {
    const text = encodeURIComponent(`ğŸ™ï¸ Yalla Habibi\n${SHARE_CONFIG.url}`);
    window.open(`https://twitter.com/intent/tweet?text=${text}`);
  }
  function shareOnLinkedIn() {
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_CONFIG.url)}`);
  }
  function shareOnWhatsApp() {
    const text = encodeURIComponent(`Yalla Habibi\n${SHARE_CONFIG.url}`);
    window.open(`https://wa.me/?text=${text}`);
  }
  function shareOnTelegram() {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_CONFIG.url)}`);
  }
  function shareOnReddit() {
    window.open(`https://reddit.com/submit?url=${encodeURIComponent(SHARE_CONFIG.url)}`);
  }
  function copyShareLink() {
    navigator.clipboard.writeText(SHARE_CONFIG.url);
    const btn = document.getElementById("copy-btn");
    btn.innerText = "âœ… Copied!";
    setTimeout(() => btn.innerText = "ğŸ“‹ Copy Link", 1500);
  }

  // =====================================================================
  // SPEECH RECOGNITION (auto language detect + correct pref)
  // =====================================================================
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRec ? new SpeechRec() : null;

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
  }

  // BCP-47 language hinting (for better auto results)
  const PREF_TO_RECO_LANG = {
    "bn-BD": "bn-BD",
    "hi-IN": "hi-IN",
    "es-ES": "es-ES",
    "pt-BR": "pt-BR",
    "fr-FR": "fr-FR",
    "de-DE": "de-DE",
    "it-IT": "it-IT",
    "ru-RU": "ru-RU",
    "ja-JP": "ja-JP",
    "ko-KR": "ko-KR",
    "zh-CN": "zh-CN",
    "tr-TR": "tr-TR",
    "ar-SA": "ar-SA",
    "en-US": "en-US"
  };

  // Prefer actual detected language; fallback to dropdown
  function pickRecognitionLang() {
    const pref = document.getElementById('pref-lang').value;
    return PREF_TO_RECO_LANG[pref] || "en-US";
  }

  // Map detected language -> our pref codes
  function mapDetectedToPref(det) {
    if (!det) return null;
    const d = det.toLowerCase();
    // normalize: "bn", "bn-bd" etc
    if (d.startsWith("bn")) return "bn-BD";
    if (d.startsWith("hi")) return "hi-IN";
    if (d.startsWith("es")) return "es-ES";
    if (d.startsWith("pt")) return "pt-BR";
    if (d.startsWith("fr")) return "fr-FR";
    if (d.startsWith("de")) return "de-DE";
    if (d.startsWith("it")) return "it-IT";
    if (d.startsWith("ru")) return "ru-RU";
    if (d.startsWith("ja")) return "ja-JP";
    if (d.startsWith("ko")) return "ko-KR";
    if (d.startsWith("zh")) return "zh-CN";
    if (d.startsWith("tr")) return "tr-TR";
    if (d.startsWith("ar")) return "ar-SA";
    if (d.startsWith("en")) return "en-US";
    return null;
  }

  // =====================================================================
  // VOICE CONTROLS (smooth)
  // =====================================================================
  const volumeSlider = document.getElementById('volume-slider');
  const speedSlider = document.getElementById('speed-slider');
  const volumeValue = document.getElementById('volume-value');
  const speedValue = document.getElementById('speed-value');

  // perceptual volume curve: slider 0..100 -> (x^1.8)
  function mapVolume(sliderVal) {
    const x = Math.max(0, Math.min(100, sliderVal)) / 100;
    return Math.pow(x, 1.8);
  }

  // smooth, natural rate: slider 50..200 -> ~0.75..1.5 (log-ish)
  function mapRate(sliderVal) {
    const v = Math.max(50, Math.min(200, sliderVal));
    const t = (v - 50) / 150; // 0..1
    // ease-in-out curve then scale
    const eased = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2)/2;
    return 0.75 + eased * 0.75; // 0.75..1.5
  }

  function updateSpeedLabel(raw) {
    const v = Number(raw);
    const label = v < 80 ? "Slow" : v < 115 ? "Normal" : "Fast";
    speedValue.textContent = `${label}`;
  }

  function updateVolumeLabel(raw) {
    volumeValue.textContent = `${raw}%`;
  }

  // init
  speechVolume = mapVolume(Number(volumeSlider.value));
  speechRate = mapRate(Number(speedSlider.value));
  updateVolumeLabel(volumeSlider.value);
  updateSpeedLabel(speedSlider.value);

  volumeSlider.addEventListener('input', function() {
    speechVolume = mapVolume(Number(this.value));
    updateVolumeLabel(this.value);
    if (currentUtterance && isSpeaking) currentUtterance.volume = speechVolume;
  });

  speedSlider.addEventListener('input', function() {
    speechRate = mapRate(Number(this.value));
    updateSpeedLabel(this.value);
    if (currentUtterance && isSpeaking) currentUtterance.rate = speechRate;
  });

  // =====================================================================
  // UI HELPERS
  // =====================================================================
  function resetUI(message = "Speak to Habibi...") {
    document.getElementById('pulse').style.display = 'none';
    document.getElementById('status').innerText = message;
    document.getElementById('mic-btn').classList.remove('recording');
  }

  function setSpeakingUI(active) {
    const stopBtn = document.getElementById('stop-btn');
    const replayBtn = document.getElementById('replay-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');

    if (active) {
      stopBtn.disabled = false;
      replayBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      document.getElementById('speaking-indicator').classList.add('active');
    } else {
      stopBtn.disabled = true;
      replayBtn.disabled = !lastResponseText;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      document.getElementById('speaking-indicator').classList.remove('active');
    }
  }

  function setPausedUI(paused) {
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    if (paused) {
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    } else {
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
    }
  }

  // =====================================================================
  // MIC BUTTON: better mobile behavior
  // =====================================================================
  const micBtn = document.getElementById('mic-btn');

  micBtn.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    startSpeech();
  }, { passive: false });

  // =====================================================================
  // RECOGNITION HANDLERS
  // =====================================================================
  if (recognition) {
    recognition.onstart = () => {
      recognitionActive = true;
      document.getElementById('pulse').style.display = 'block';
      document.getElementById('status').innerText = "Habibi is listening...";
      document.getElementById('mic-btn').classList.add('recording');
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      recognitionActive = false;
      resetUI("Error: " + event.error + ". Try again!");
    };

    recognition.onend = () => {
      recognitionActive = false;
      // if still showing listening, then it ended without results
      if (document.getElementById('status').innerText === "Habibi is listening...") {
        resetUI("No speech detected. Try again!");
      }
    };

    recognition.onresult = (event) => {
      const result = event.results[0][0];
      const text = result.transcript || "";
      const detectedLang = (result.lang || event.results[0].lang || recognition.lang || "").trim();

      // AUTO: if browser provides language, switch pref to match
      const mapped = mapDetectedToPref(detectedLang);
      if (mapped) {
        const prefEl = document.getElementById('pref-lang');
        if (prefEl && prefEl.value !== mapped) prefEl.value = mapped;
      }

      const pref = document.getElementById('pref-lang').value;

      document.getElementById('user-transcript').innerText = `"${text}"`;
      document.getElementById('status').innerText = "Processing...";
      document.getElementById('pulse').style.display = 'none';

      fetch(`/api/chat?user_input=${encodeURIComponent(text)}&pref=${encodeURIComponent(pref)}`)
        .then(r => {
          if (!r.ok) throw new Error('Network response was not ok');
          return r.json();
        })
        .then(data => {
          resetUI("Response received! Speak again...");

          const parts = (data.reply || "").split('--- Wisdom:');
          document.getElementById('response-text').innerText = parts[0] || "";

          if (parts[1]) {
            document.getElementById('wisdom-box').classList.remove('hidden');
            document.getElementById('wisdom-text').innerText = "ğŸŒ± " + parts[1].trim();
          } else {
            document.getElementById('wisdom-box').classList.add('hidden');
          }

          if (data.map_link) {
            document.getElementById('map-wrap').classList.remove('hidden');
            document.getElementById('google-map').src = data.map_link;
          } else {
            document.getElementById('map-wrap').classList.add('hidden');
          }

          lastResponseText = data.reply || "";
          lastResponseLang = data.voice_lang || pref;

          speak(lastResponseText, lastResponseLang);
        })
        .catch(error => {
          console.error('Fetch error:', error);
          resetUI("Error connecting. Try again!");
          document.getElementById('response-text').innerText = "Habibi encountered an error. Please try again.";
        });
    };
  }

  function startSpeech() {
    if (!recognition) {
      alert("Speech recognition not supported in this browser.");
      return;
    }
    // stop TTS if user starts speaking
    if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
      window.speechSynthesis.cancel();
      isSpeaking = false;
      isPaused = false;
      setSpeakingUI(false);
    }

    if (recognitionActive) return; // prevent double-start
    try {
      recognition.lang = pickRecognitionLang(); // IMPORTANT: set before start
      recognition.start();
    } catch (e) {
      console.log('Recognition start error:', e);
    }
  }

  // =====================================================================
  // SPEAK + PAUSE/RESUME (true mid-utterance)
  // =====================================================================
  function speak(text, lang) {
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.volume = speechVolume;
    utterance.rate = speechRate;

    const voices = window.speechSynthesis.getVoices();

    // Try exact match first
    let selectedVoice = voices.find(v => v.lang === lang);

    if (!selectedVoice) {
    document.querySelector('.voice-hint').style.display = 'block';
}

    // Fallback by language prefix (bn, ar, en etc)
    if (!selectedVoice) {
        const prefix = lang.split('-')[0];
        selectedVoice = voices.find(v => v.lang.startsWith(prefix));
    }

    if (selectedVoice) {
        utterance.voice = selectedVoice;
        console.log("âœ… Voice selected:", selectedVoice.name);
    } else {
        console.warn("âš  No native voice for:", lang, "â†’ Using default");
    }

    currentUtterance = utterance;
    isSpeaking = true;

    document.getElementById('speaking-indicator').classList.add('active');
    document.getElementById('stop-btn').disabled = false;

    utterance.onend = () => {
        isSpeaking = false;
        isPaused = false;
        document.getElementById('speaking-indicator').classList.remove('active');
        document.getElementById('stop-btn').disabled = true;
        document.getElementById('replay-btn').disabled = false;
    };

    window.speechSynthesis.speak(utterance);
}

  function pauseSpeaking() {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
      window.speechSynthesis.pause();
      isPaused = true;
      setPausedUI(true);
      console.log("â¸ï¸ Paused");
    }
  }

  function resumeSpeaking() {
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
      isPaused = false;
      setPausedUI(false);
      console.log("â–¶ï¸ Resumed");
    }
  }

  function stopSpeaking() {
    window.speechSynthesis.cancel();
    isSpeaking = false;
    isPaused = false;
    setSpeakingUI(false);
    setPausedUI(false);
    console.log('ğŸ›‘ Speech stopped by user');
  }

  function replaySpeech() {
    if (lastResponseText) {
      console.log('ğŸ” Replaying last response');
      speak(lastResponseText, lastResponseLang);
    }
  }

  // =====================================================================
  // FEEDBACK (kept)
  // =====================================================================
  function postFeedback() {
    const val = document.getElementById('feedback-in').value;
    if (val) {
      document.getElementById('ticker').innerText = `"${val}" - ` + document.getElementById('ticker').innerText;
      document.getElementById('feedback-in').value = "";
      alert("Mabrouk! Feedback shared with the world.");
    }
  }

  // =====================================================================
  // KEYBOARD SHORTCUTS (kept + added pause/resume)
  // SPACE=Listen | ESC=Stop | R=Replay | P=Pause/Resume
  // =====================================================================
  document.addEventListener('keydown', function(event) {
    if (event.code === 'Space' && event.target.tagName !== 'INPUT') {
      event.preventDefault();
      startSpeech();
    }
    if (event.code === 'Escape') {
      stopSpeaking();
    }
    if (event.code === 'KeyR' && !event.ctrlKey && event.target.tagName !== 'INPUT') {
      replaySpeech();
    }
    if (event.code === 'KeyP' && !event.ctrlKey && event.target.tagName !== 'INPUT') {
      if (window.speechSynthesis.paused) resumeSpeaking();
      else pauseSpeaking();
    }
  });

  console.log('ğŸ¤ Shortcuts: SPACE=Listen | ESC=Stop | R=Replay | P=Pause/Resume');
  console.log("âœ… Share system locked to:", SHARE_CONFIG.url);
</script>

{% endblock %}
